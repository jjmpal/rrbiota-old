---
title: "Compare pseqs"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis', cache=FALSE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

dir.create("rds-comparepseqs/", showWarnings = FALSE)
dir.create("session/", showWarnings = FALSE)
```

```{r Command line arguments}
now <- format(Sys.time(), '%Y%m%d-%H%M%S')

if (exists("args")) {
    if ("time" %in% names(args)) now <- args$time
    
    if("clean" %in% names(args)) {
        unlink("rds-comparepseqs", recursive=TRUE)
        unlink("cache", recursive=TRUE)
    }
    if ("loadlast" %in% names(args) )
        load(paste0("session/", sort(list.files("session"), decreasing = TRUE)[1]))
}
```

# Importing libraries:

```{r libraries}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(parallel)
library(knitr)
library(gridExtra)
```

### RR biome functions

<details>
  <summary>Open/Close</summary>
  
```{r RR biome functions, code=readLines("articletwo-rrbiome.R")}
source("articletwo-rrbiome.R")
```

</details>

### Plot functions

<details>
  <summary>Open/Close</summary>

```{r Plot functions, code=readLines("articletwo-ggplot.R")}
source("articletwo-ggplot.R")
```

</details>

# Loading data

 phyloseq-objektit: 1) SHOGUN 2) CENTRIFUGE 3) NCBI70 4) GTDB 5) 16S

```{r data}
pseq = list()
pseq$shogun <- import_filter_data("data/phfinrisk_species_all_drop50k_2018-12-21.RDs")
pseq$R16S <- import_filter_data("data/phfinrisk_16S_otu_raw_2019-02-19.RDs")
pseq$gtdb <- import_filter_data("data/phfinrisk_gtdb_species_all_drop50k_2019-01-14.RDs")
pseq$ncbi <- import_filter_data("data/phfinrisk_custom70_species_all_2019-01-29.RDs")
pseq$centrifuge <- import_filter_data("data/phfinrisk_centrifuge_species_all_2018-11-30.RDs",
                                      excluded = c("DIAB"))
```

```{r alpha diversities}
dset <- mclapply(pseq, function(x) meta.merge.alphadiversity(x) %>%
                                             mutate(diversities_shannon = scale(diversities_shannon)),
                           mc.cores = length(pseq))

fo.alpha.min <- "%s ~ BL_AGE + SEX  + diversities_shannon"
fo.alpha.full <- "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09 + diversities_shannon" # MISSING DIAB

alphadiversity <-  mclapply(dset, function(x)
    list(min =  calculateglm(x, modelstring = fo.alpha.min),
         full = calculateglm(x, modelstring = fo.alpha.full)),
    mc.cores = length(pseq))
```


```{r dissimilarity matrix}
if (!file.exists("rds-comparepseqs/comparepseqs_bray_matrix.rds")) {
    bray.dist.matrix <- mclapply(pseq, function(x) calculate.beta.matrix(x), mc.cores = length(pseq))
    saveRDS(bray.dist.matrix, file = "rds-comparepseqs/comparepseqs_bray_matrix.rds")
} else {
    bray.dist.matrix  <- readRDS("rds-comparepseqs/comparepseqs_bray_matrix.rds")
}
```

 ```{r adonis calculation}
 if (!file.exists("rds-comparepseqs/beta.diversity.rds")) {
     covariates.min <- c("BL_AGE", "SEX")
     covariates.full <- c("BL_AGE", "SEX", "BMI", "CURR_SMOKE",
                          "Q57X", "BL_USE_RX_C03", "BL_USE_RX_C07",
                          "BL_USE_RX_C08", "BL_USE_RX_C09")

     betadiversity <- mclapply(c2l(names(pseq)), function(x)
         list(min = calculateadonis(dset = meta(pseq[[x]]),
                                    matrix = bray.dist.matrix[[x]],
                                    covariates = covariates.min,
                                    npermutations = 1000),
              full = calculateadonis(dset = meta(pseq[[x]]),
                                           matrix = bray.dist.matrix[[x]],
                                           covariates = covariates.full
                                           npermutations = 1000)
         mc.cores = length(pseq))
     saveRDS(betadiversity, file = "rds-comparepseqs/beta.diversity.rds")
    } else {
     betadiversity <- readRDS("rds-comparepseqs/beta.diversity.rds")
}
```


```{r plot alpha diversity, eval = FALSE}
beta.min <- lapply(c2l(names(pseq)), function(x) {
    alpha.min[[x]] %>% mutate(R2 = 0) %>% select(model_name, R2, response)
})

beta.min[[1]] %>%
         data.table::rbindlist(id = "model_name")

#            dplyr::filter(term %in% responses) %>%
            dplyr::select(response, R2)

diversity.min <- mergediversities(alpha.min, beta.min)


alpha.plot.min <- mclapply(alpha.min, function(x) { mergediversities(x, 
                               },
                               ## plot.alpha(x %>%
                               ##                    mutate(Name = term,
                               ##                           R2 = 0,
                               ##                           Qstar = ifelse(p.value < 0.05, '*', ' ')),
                               ##                    colorlimit = 0.6),
                           mc.cores = length(pseq))

gs4 <- c(list("yaxis" = alpha.plot.min[[1]]$yaxis,
              "xaxis" = alpha.plot.min[[1]]$xaxis),
              lapply(alpha.plot.min, function(x) x$plot))

g4.firstline <- c(1, seq(3, length(alpha.plot.min)+2))
g4.secondline <- c(NA, rep(2, length(alpha.plot.min)))

g4 <- arrangeGrob(grobs = gs4, layout_matrix = rbind(g4.firstline, g4.secondline))

ggsave(file = "cache/pseqdiff-alpha-min.png", plot=g4, height=6, width=9)
                       
```

```{r join alphas, eval = FALSE}
sfx <- names(dset)
res <- alpha.min[[1]]

for(i in head(seq_along(alpha.min), -1)) {
    res <- merge(res,
                 alpha.full[[i+1]],
                 all = TRUE,
                 suffixes = paste0("_", sfx[i:(i+1)]),
                 by = c("model_name", "term", "response"))
}

res %>% colnames

res %>%
    dplyr::select(response, starts_with("estimate_"), starts_with("p.value"))

```






```{r save session}
save.image(file = paste0("session/comparepseqs.Rdata"))
```
