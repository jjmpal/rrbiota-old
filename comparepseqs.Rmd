---
title: "Compare pseqs"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis', cache=FALSE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

dir.create("rds-comparepseqs/", showWarnings = FALSE)
dir.create("session/", showWarnings = FALSE)
```

```{r packrat, include = FALSE, eval = FALSE}
packrat::opts$ignored.packages(c("Maaslin", "finriskmetagcommon", "biomformat",
                                 "microbiome", "phyloseq" ))
packrat::snapshot()
```

```{r Command line arguments}
now <- format(Sys.time(), '%Y%m%d-%H%M%S')

if (exists("args")) {
    if ("time" %in% names(args)) now <- args$time
    
    if("clean" %in% names(args)) {
        unlink("rds-comparepseqs", recursive=TRUE)
        unlink("cache", recursive=TRUE)
    }
    if ("loadlast" %in% names(args) )
        load("session/comparepseqs.Rdata")

    if ("subset" %in% names(args))
        subset.run <- as.numeric(args$subset)
}
```

# Importing libraries:

```{r libraries}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(parallel)
library(knitr)
library(gridExtra)
library(vegan)
library(ggpubr)
library(broom)
library(tidyr)
library(GGally)
```

### RR biome functions

<details>
  <summary>Open/Close</summary>
  
```{r RR biome functions, code=readLines("articletwo-rrbiome.R")}
source("articletwo-rrbiome.R")
```

</details>

### Plot functions

<details>
  <summary>Open/Close</summary>

```{r Plot functions, code=readLines("articletwo-ggplot.R")}
source("articletwo-ggplot.R")
```

</details>

# Loading data

Loading descriptions for clinical data

```{r variables, warning = FALSE}
names.dset <- getdescriptions()
```


 phyloseq-objektit: 1) SHOGUN 2) CENTRIFUGE 3) NCBI70 4) GTDB 5) 16S

```{r constants}
fo.alpha.min <- "%s ~ BL_AGE + SEX  + diversities_shannon"
fo.alpha.full <- "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09 + diversities_shannon" # MISSING DIAB

covariates.min <- c("BL_AGE", "SEX")
covariates.full <- c("BL_AGE", "SEX", "BMI", "CURR_SMOKE",
                         "Q57X", "BL_USE_RX_C03", "BL_USE_RX_C07",
                         "BL_USE_RX_C08", "BL_USE_RX_C09")
```

```{r rds files}
rds <- list("shogun" = "data/phfinrisk_species_all_drop50k_2018-12-21.RDs",
            "centrifuge" = "data/phfinrisk_centrifuge_species_all_2018-11-30.RDs",
            "gtdb" = "data/phfinrisk_gtdb_species_all_drop50k_2019-01-14.RDs",
            "ncbi" = "data/phfinrisk_custom70_species_all_2019-01-29.RDs",
            "R16S" = "data/phfinrisk_16S_otu_genus_2019-02-20.RDs")
```

```{r subset runs}
if (exists("subset.run")) {
    message(sprintf("Subset %s of %s", subset.run, rds[[subset.run]]))
    rds <- rds[subset.run]
}
``` 

```{r alpha scatter, include = FALSE, eval = FALSE}
rds = rds[c(1,2,4)]
ret <- list()

for (key in names(rds)) {
    missing = list()

    if (!file.exists(paste0("rds-comparepseqs/alphadistribution-", key , ".rds"))) {
        missing$alphadistribution = TRUE
    } else {
        alphadistribution <- readRDS(file =
                                         paste0("rds-comparepseqs/alphadistribution-",
                                                key , ".rds"))
    }
    
    ret[[key]] = list("alphadistribution" = alphadistribution)
}
```

# Calculate alpha and beta diversity

```{R models}
ret <- list()

for (key in names(rds)) {
    pseq <- import_filter_data(rds[[key]],
                               included = c("MEN", "BL_AGE", "SYSTM", "DIASM", "BMI",
                                            "CURR_SMOKE", "BL_USE_RX_C09",
                                            "Q57X", "BL_USE_RX_C03",
                                            "BL_USE_RX_C07", "BL_USE_RX_C08"))

    bray.dist.m.species <- calculate.beta.matrix(pseq)
    
    adonis.species <- calculate.betadiversity(pseq = pseq.species,
                                               matrix = bray.dist.m.species,
                                               vars = list("max" = var.CL,
                                                            "min" = var.CL.min))
    
    alphadiversity <- calculate.alphadiversity(pseq.species,
                                               list("max" = var.CL,
                                                    "min" = var.CL.min))


    alphadiversity <- calculate.alphadiversity(pseq.species,
                                               list("max" = var.CL,
                                                    "min" = var.CL.min))

    diversities <- mergediversities(alphadiversity, adonis.species, names.dset = names.dset)

    g4 <- plot.diversities(diversities)
    ggsave(file = sprintf("cache/comparepseqs-%s.png", key), plot=g4, height=6, width=9)
}
```

