---
title: "Compare pseqs"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis', cache=FALSE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

dir.create("rds-comparepseqs/", showWarnings = FALSE)
dir.create("session/", showWarnings = FALSE)
```

```{r packrat, include = FALSE, eval = FALSE}
packrat::opts$ignored.packages(c("Maaslin", "finriskmetagcommon", "biomformat",
                                 "microbiome", "phyloseq" ))
packrat::snapshot()
```

```{r Command line arguments}
now <- format(Sys.time(), '%Y%m%d-%H%M%S')

if (exists("args")) {
    if ("time" %in% names(args)) now <- args$time
    
    if("clean" %in% names(args)) {
        unlink("rds-comparepseqs", recursive=TRUE)
        unlink("cache", recursive=TRUE)
    }
    if ("loadlast" %in% names(args) )
        load("session/comparepseqs.Rdata")

    if ("subset" %in% names(args))
        subset.run <- as.numeric(args$subset)
}
```

# Importing libraries:

```{r install, eval = FALSE, include = FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite("BiocInstaller")
library(BiocInstaller)
source("http://www.bioconductor.org/biocLite.R")
biocLite("microbiome")
```

```{r libraries}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(parallel)
library(knitr)
library(gridExtra)
library(vegan)
```

### RR biome functions

<details>
  <summary>Open/Close</summary>
  
```{r RR biome functions, code=readLines("articletwo-rrbiome.R")}
source("articletwo-rrbiome.R")
```

</details>

### Plot functions

<details>
  <summary>Open/Close</summary>

```{r Plot functions, code=readLines("articletwo-ggplot.R")}
source("articletwo-ggplot.R")
```

</details>

# Loading data

 phyloseq-objektit: 1) SHOGUN 2) CENTRIFUGE 3) NCBI70 4) GTDB 5) 16S




```{r constants}
fo.alpha.min <- "%s ~ BL_AGE + SEX  + diversities_shannon"
fo.alpha.full <- "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09 + diversities_shannon" # MISSING DIAB

covariates.min <- c("BL_AGE", "SEX")
covariates.full <- c("BL_AGE", "SEX", "BMI", "CURR_SMOKE",
                         "Q57X", "BL_USE_RX_C03", "BL_USE_RX_C07",
                         "BL_USE_RX_C08", "BL_USE_RX_C09")
```

```{r rds files}
rds <- list("shogun" = "data/phfinrisk_species_all_drop50k_2018-12-21.RDs",
            "centrifuge" = "data/phfinrisk_centrifuge_species_all_2018-11-30.RDs",
            "gtdb" = "data/phfinrisk_gtdb_species_all_drop50k_2019-01-14.RDs",
            "ncbi" = "data/phfinrisk_custom70_species_all_2019-01-29.RDs",
            "R16S" = "data/phfinrisk_16S_otu_raw_2019-02-19.RDs")
```

```{r subset runs}
if (exists("subset.run")) {
    message(paste0("Subset ", subset.run))
    rds <- rds[[subset.run]]
}


message(rds)
quit()
``` 

```{r models}
ret <- list()

for (key in names(rds)) {
    pseq <- import_filter_data(rds[[key]] ,excluded = c("DIAB"))
    dset <- meta.merge.alphadiversity(pseq) %>%
        mutate(diversities_shannon = scale(diversities_shannon))

    alphadiversity <- list(min =  calculateglm(dset, modelstring = fo.alpha.min),
                           full = calculateglm(dset, modelstring = fo.alpha.full))

    saveRDS(alphadiversity,
            file = paste0("rds-comparepseqs/alpha-", key , ".rds"))
    
    bray.dist.matrix <- calculate.beta.matrix(pseq)

    saveRDS(bray.dist.matrix,
            file = paste0("rds-comparepseqs/bray-", key , ".rds"))
    
    betadiversity <- list(min = calculateadonis(dset = dset,
                                                matrix = bray.dist.matrix,
                                                covariates = covariates.min,
                                                npermutations = 1000),
                          full = calculateadonis(dset = dset,
                                                 matrix = bray.dist.matrix,
                                                 covariates = covariates.full,
                                                 npermutations = 1000))

    saveRDS(betadiversity,
            file = paste0("rds-comparepseqs/alpha-", key , ".rds"))

    ret[[key]] = list("alphadiversity"  = alphadiversity,
                      "betadiversity" = betadiversity)
}
```

```{r plot, eval = FALSE}
plotlist <- list()

for (key in names(rds)) {
    diversities <- mergediversities(ret[[key]][["alphadiversity"]],
                                    ret[[key]][["betadiversity"]])

    alpha.diversity.min <- plot.alpha(diversities$min, colorlimit = 0.6)
    alpha.diversity.max <- plot.alpha(diversities$max, colorlimit = 0.6)

    beta.diversity.min <- plot.beta(diversities$min)
    beta.diversity.max <- plot.beta(diversities$max)

    gs4 <- list(alpha.diversity.min$yaxis,
                alpha.diversity.min$plot,
                beta.diversity.min$plot,
                alpha.diversity.min$legend,
                alpha.diversity.min$xaxis,
                beta.diversity.min$xaxis,
                beta.diversity.min$xlab,
                text_grob("A.", size = 18),
                alpha.diversity.max$yaxis,
                alpha.diversity.max$plot,
                beta.diversity.max$plot,  
                alpha.diversity.max$xaxis,
                beta.diversity.max$xaxis,
                beta.diversity.max$xlab,
                text_grob("B.", size = 18))
    
    g4 <- arrangeGrob(grobs = gs4,
                      layout_matrix = rbind(
                          c(8,    NA,    NA, NA,   NA, NA, NA),
                          c(NA, 1,    2,    NA, 3, NA, NA),
                          c(NA, 1,    2,    NA, 3, NA, 4),
                          c(NA, NA, 5,    NA,6, NA, NA),
                          c(NA, NA, NA, NA,7, NA, NA),
                          c(15,    NA,    NA, NA,   NA, NA, NA),
                          c(NA, 9,    10,  NA,  11, NA, NA),
                          c(NA, 9,    10,  NA,  11, NA, NA),
                          c(NA, NA, 12,   NA, 13, NA, NA),
                          c(NA, NA, NA, NA,14, NA, NA)),
                      widths=c(0.7, 4, 0.7, 0.1, 5, 0.7, 3),
                      heights=rep(c(1, 1, 6, 1, 2), 2))

    ggsave(file = paste0("cache/alpha-beta-", key , ".png"), plot=g4, height=6, width=9)
    plotlist[[key]] = g4
}
```



```{r plot alpha diversity, eval = FALSE}

alphadiversity <- readRDS("rds-comparepseqs/alpha-R16S.rds")
alphadiversity

diversity.min <- mergediversities(alpha.min, beta.min)


alpha.plot.min <- mclapply(alpha.min, function(x) { mergediversities(},
                               mc.cores = length(pseq))

gs4 <- c(list("yaxis" = alpha.plot.min[[1]]$yaxis,
              "xaxis" = alpha.plot.min[[1]]$xaxis),
              lapply(alpha.plot.min, function(x) x$plot))

g4.firstline <- c(1, seq(3, length(alpha.plot.min)+2))
g4.secondline <- c(NA, rep(2, length(alpha.plot.min)))

g4 <- arrangeGrob(grobs = gs4, layout_matrix = rbind(g4.firstline, g4.secondline))

ggsave(file = "cache/pseqdiff-alpha-min.png", plot=g4, height=6, width=9)
                       
```

```{r join alphas, eval = FALSE}
sfx <- names(dset)
res <- alpha.min[[1]]

for(i in head(seq_along(alpha.min), -1)) {
    res <- merge(res,
                 alpha.full[[i+1]],
                 all = TRUE,
                 suffixes = paste0("_", sfx[i:(i+1)]),
                 by = c("model_name", "term", "response"))
}

res %>% colnames

res %>%
    dplyr::select(response, starts_with("estimate_"), starts_with("p.value"))

```
