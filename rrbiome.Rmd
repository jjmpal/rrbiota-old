---
title: "Hypertension and microbiome"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis', cache=TRUE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

dir.create("rds/", showWarnings = FALSE)
```

Importing libraries:

```{r libraries, cache = FALSE}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(finriskmetagcommon)
library(knitr)
library(tidyr)
library(vegan)
library(reshape)
library(ggpmisc)
library(Maaslin)
library(parallel)
```

# Function definitions

```{r functions}
filter.phenotype.data <- function(pseq,
                                  included = c("DNA_OK", "MEN", "BL_AGE", "SYSTM", "DIASM", "BP_TREAT", "BMI",
                                               "CURR_SMOKE", "DIAB", "BL_USE_RX_C09", "Q57X", "BL_USE_RX_C03",
                                               "BL_USE_RX_C07", "BL_USE_RX_C08"))
    meta(pseq) %>%
        tibble::rownames_to_column(var = "rowname") %>%
        dplyr::select(rowname, included) %>% 
        dplyr::mutate(ANYDRUG = factor(ifelse(BL_USE_RX_C03  == 1 | BL_USE_RX_C07 == 1 |
                                       BL_USE_RX_C08 == 1  | BL_USE_RX_C09 == 1, 1, 0)),
                      ANYEXERCICE = factor(ifelse(Q57X == 1, 0, 1)),
                      PULSEPRESSURE = SYSTM - DIASM,
                      HYPERTENSION = factor(ifelse(SYSTM >= 140 | DIASM >= 90 | ANYDRUG == 1, 1, 0)),
                      SEX = factor(ifelse(MEN == "Female", 1, 0)),
                      MAP = 2./3.*DIASM + 1./3.*SYSTM) %>%
         stats::na.omit() %>%
        dplyr::select(-MEN, -DNA_OK) %>%
        tibble::remove_rownames() %>%
        tibble::column_to_rownames(var = "rowname")

meta.merge.alphadiversity <- function(pseq, index = "shannon") {
    alphadiversity  <- microbiome::global(pseq, index = index)
    base::merge(meta(pseq), alphadiversity, by=0, all=TRUE) %>%
        dplyr::rename(Sample_ID = Row.names) %>%
            dplyr::mutate(BL_AGE_GROUP = group_age(BL_AGE))
}

calculate.beta.matrix <- function(pseq) {
    compositional.profile <- microbiome::transform(pseq, 'compositional')
    otu <- microbiome::abundances(compositional.profile)
    bray.dist.m <- vegan::vegdist(t(otu), method="bray")
    dist.matrix <- as.matrix(bray.dist.m)
    attr(dist.matrix, "method") <- "bray"
    dist.matrix
}
calculateglm <- function(dset,
                         responses = list(model_1 = "MAP", model_2 = "SYSTM", model_3 = "DIASM",
                                          model_4 = "PULSEPRESSURE", model_5 = "HYPERTENSION"),
                         min_n_for_continuous = 10,
                         modelstring = "%s ~ BL_AGE + SEX") {
    glmlist <- lapply(responses, function(response) {
        fo.family <- ifelse(length(unique(pull(dset, response))) > min_n_for_continuous, stats::gaussian, stats::binomial)
        fo <- sprintf(modelstring, response)
        stats::glm(formula = as.formula(fo), family = fo.family, data = dset) %>%
            broom::tidy() %>%
                dplyr::filter(grepl("diversities_", term)) %>%
                dplyr::mutate(response = response, fo = fo) %>%
                dplyr::select(-term)
    })
    data.table::rbindlist(glmlist, id = "model_name") %>%
        as.data.frame %>%
        dplyr::mutate(conf.low = estimate - qnorm(1- 0.05/2) * std.error,
                      conf.high = estimate + qnorm(1- 0.05/2) * std.error)
}

calculateadonis <- function(dset,
                            matrix,
                            responses = list(model_1 = "MAP", model_2 = "SYSTM", model_3 = "DIASM",
                                          model_4 = "PULSEPRESSURE", model_5 = "HYPERTENSION"),
                            covariates = "BL_AGE + SEX",
                            modelstring = "matrix ~ %s + %s",
                            npermutations = 99) {
    ret  <- mclapply(responses, function(response) {
        fo <- sprintf(modelstring, response, covariates)
        ad <- adonis(as.formula(fo), data = dset, permutations = npermutations)
        ad$aov.tab %>%
            as.data.frame %>%
            tibble::rownames_to_column(var = "term") %>%
            dplyr::mutate(response = response, fo = fo)
      }, mc.cores = length(responses))
    data.table::rbindlist(ret, id = "model_name") %>%
        dplyr::filter(term %in% responses) %>%
            dplyr::select(-term)
}
```

# Loading data
	
Loading descriptions for clinical data

```{r variables}
data("phfinrisk_metadatadesc", package="finriskmetagcommon")
names.dset <- filter(phfinrisk_metadatadesc,
                     Ignored.Covariate.in.Cross.Sectional.Analysis.Aaro20181115==0)
names.dset <- bind_rows(names.dset,
                        data.frame(Covariate = c("MAP", "PULSEPRESSURE", "HYPERTENSION"),
                                   Category = rep("Physical", 3),
                                   Name =c( "Mean artrerial pressure", "Pulse pressure", "Hypertension")))
```

Loading phyloseq object

```{r data}
pseq.genus <- readRDS("data/phfinrisk_genus_all_drop50k_2018-11-16.RDs")
pseq.species <- readRDS("data/phfinrisk_species_all_drop50k_2018-12-21.RDs")
```

Filtering clinical data

```{r filtering}
dset.genus <- filter.phenotype.data(pseq.genus)
dset.species <- filter.phenotype.data(pseq.species)
```

Phenotypical data between genus and species all.equal `r 
isTRUE(all.equal(dset.genus, dset.species))`. Dimension for data
frames are (`r dim(dset.genus)`) and (`r dim(dset.species)`).

Updating phyloseq objects

```{r updating phyloseq objects}
phyloseq::sample_data(pseq.genus) <- phyloseq::sample_data(dset.genus)
phyloseq::sample_data(pseq.species) <- phyloseq::sample_data(dset.species)
```

Sample data has dimensions (`r dim(sample_data(pseq.species))`).

# Self reported vs. registered medication

Contigency table for RR mediaction. 

```{r self vs registered medication}
tbl <- table(dset.species$BP_TREAT, dset.species$ANYDRUG)
colnames(tbl) <- c("ANYDRUG 0", "ANYDRUG 1")
rownames(tbl) <- c("BP_TREAT 0", "BP_TREAT 1")
tbl %>%
    kable(.)
```

$\chi^2$-test for medication `r format.pval(chisq.test(dset.species$BP_TREAT, dset.species$ANYDRUG, correct=FALSE)$p.value)`.

# How large subgroups are?

Number of participants in each combination of all categorical variables

```{r numbers by group}
dset.species %>%
    group_by(SEX, CURR_SMOKE,  HYPERTENSION, Q57X, DIAB,
             BL_USE_RX_C09, BL_USE_RX_C03, BL_USE_RX_C07, BL_USE_RX_C08) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    kable            
```

Number of particiapants in each combination after combining RR
medication and exercice to binomial variables.

```{r numbers by group reduced}
dset.species %>%
     group_by(SEX, CURR_SMOKE,  HYPERTENSION, DIAB, ANYDRUG, ANYEXERCICE) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    kable
```

# Alpha diversity

Dset with alpha diversity

```{r alpha diversity}
dset.alpha <- meta.merge.alphadiversity(pseq.species)
```

Scatterplots for alpha diversity by age group and sex.

```{r alpha-MAP scatter plots, fig.width=10, fig.height=15}
ggplot(dset.alpha %>% mutate(SEX = ifelse(SEX == 0, "Male", "Female")), aes(x=diversities_shannon, y=MAP)) +
    facet_wrap(~BL_AGE_GROUP + SEX, ncol=2, scales = "free") +
    geom_point(size=0.1, shape=1, aes(colour = ANYDRUG)) +
    scale_colour_manual(values = c("red","blue", "green")) +
    geom_smooth(method=lm, se=TRUE, size=0.5, color = 'Black') +
    stat_poly_eq(formula = "y ~ x",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 label.y = 0,
                 parse = TRUE,
                 size = 3) +   
    ylim(0, 200) +
    ggplot2::theme_minimal() 
```

Calculating linear models for alpha diversity.

```{r calculate full alpha model}
calculateglm(dset.alpha, modelstring = "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09  + diversities_shannon") %>%
    select(response, estimate, std.error, conf.low, conf.high, p.value) %>%
    kable(.)
```

Calculating linear model using binomial variable for exercice and medication.

```{r calculate binomial alpha model}
calculateglm(dset.alpha, modelstring = "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + ANYEXERCICE + DIAB + ANYDRUG  + diversities_shannon") %>%
    select(response, estimate, std.error, conf.low, conf.high, p.value) %>%
    kable(.)
```


Calculating linear model using minimal variables.

```{r calculate minimal alpha model}
calculateglm(dset.alpha, modelstring = "%s ~ BL_AGE + SEX + diversities_shannon") %>%
    select(response, estimate, std.error, conf.low, conf.high, p.value) %>%
    kable(.)
```


# Beta diversity

Calculating the distance matrix from data after compositional
transformation using vegdist and bray method.

```{r matrix calculation, cache = FALSE}
if (!file.exists("rds/bray.dist.m.species.rds") || !file.exists("rds/bray.dist.m.genus.rds")) {
    bray.dist.m.species <- calculate.beta.matrix(pseq.species)
    saveRDS(bray.dist.m.species, file = "rds/bray.dist.m.species.rds")
    bray.dist.m.genus <- calculate.beta.matrix(pseq.genus)
    saveRDS(bray.dist.m.genus, file = "rds/bray.dist.m.genus.rds")
} else {
    bray.dist.m.species  <- readRDS("rds/bray.dist.m.species.rds")
    bray.dist.m.genus <- readRDS("rds/bray.dist.m.genus.rds")
}
```

Calculating beta diversity for blood pressure variables using adonis

 ```{r adonis calculation, cache = FALSE}
if (!file.exists("rds/adonis.species.rds")) {
    adonis.species <- calculateadonis(dset = meta(pseq.species),
                    matrix = bray.dist.m.species,
                    covariates = "BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09",
                    npermutations = 99)
     saveRDS(adonis.species, file = "rds/adonis.species.rds")
} else {
     adonis.species  <- readRDS("rds/adonis.species.rds")
}
```                     

Printing the results for adonis run for blood pressure variables in
full model

```{r adonis3}
 adonis.species %>%
    select(response, SumsOfSqs, MeanSqs, F.Model, R2, "Pr(>F)") %>%
    kable(.)
```

# PCA

We calculate primary component analysis using centered log-ratio
transformation for the abunances.

```{r pca}
if (!file.exists("rds/pca.prcomp.rds")) {
    pca.abundances  <- as.matrix(t(microbiome::abundances(microbiome::transform(pseq.species, "clr"))))
    pca.prcomp <- stats::prcomp(pca.abundances)
    saveRDS(pca.prcomp, file = "rds/pca.prcomp.rds")
} else {
     pca.prcomp <- readRDS("rds/pca.prcomp.rds")
}
```

Proportion of variance for main PC axis

```{r pca percentage}
pca.eigs <- pca.prcomp$sdev^2
pca.percentage <- 100 * pca.eigs /sum(pca.eigs)
pca.labels <- sprintf("%s (%.2f %%)", colnames(pca.prcomp$x), pca.percentage)
setNames(pca.percentage, pca.prcomp$x %>% colnames) %>% head(10) %>% t %>% kable
```

PCA plot for hypertension

```{r PCA plots continuous, fig.width = 10, fig.height = 6, dpi = 300}
ggplot(cbind(meta(pseq.species), pca.prcomp$x[,1:2]), aes(x=PC1, y=PC2)) +
    geom_point(aes(color = HYPERTENSION), size = 0.2) +
    xlab(pca.labels[1]) +
    ylab(pca.labels[2]) +
    scale_color_brewer(palette="Dark2") +
    ggplot2::theme_minimal() 
```

# Connection between genus and blood pressure

Aaron work-december-2018 *prepare_maaslin_input.R*

```{r prepare maaslin}
prepare.maaslin <- function (pseq,
                             tsvfile = "merged_phfinrisk_genus.tsv",
                             conffile = "maaslin_config.config",
                             includedvars = c("BL_AGE", "BMI", "SEX"),
                             readpclrows = "Archaea.Archaea-") {
    pheno <- t(microbiome::meta(phyloseq::sample_data(pseq)))
    sample.ids <- colnames(pheno)
    phfg.pseq.rel <- microbiome::transform(pseq, "compositional")
    abud.rel <- abundances(phfg.pseq.rel)
    rownames(abud.rel) <- sapply(rownames(abud.rel),
                                 function (genus) gsub("(.*) \\(+(.+)\\)", '\\1.\\2', genus))
    write.table(t(rbind(sample.ids, pheno, abud.rel)), file = tsvfile, sep='\t', quote=FALSE, row.names=FALSE, col.names=TRUE)
    data <- file(conffile , open='wt')
    pcl.contents <- c("Matrix: Metadata",
                      paste(c("Read_PCL_Rows: ", paste(includedvars, collapse=",")), collapse = ""),
                      "",
                      "Matrix: Adundance",
                      paste("Read_PCL_Rows:", readpclrows))
    writeLines(pcl.contents, con=data)
    close(data)
}

 merge.pheno.abu <- function(pseq) {
     pheno <- microbiome::meta(phyloseq::sample_data(pseq))
     sample.ids <- rownames(pheno)
     phfg.pseq.rel <- microbiome::transform(pseq, "compositional")
     abud.rel <- abundances(phfg.pseq.rel)
     rownames(abud.rel) <- sapply(rownames(abud.rel), function (genus) gsub("(.*) \\(+(.+)\\)", '\\1.\\2', genus))
     cbind(pheno, t(abud.rel))
}
```

Running maaslin for blood pressure variables while rest of the
phenotype variables are forced in the model

```{r run maaslin, echo = FALSE, warnings = FALSE, message=FALSE} 
maaslin.force.vars <- c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB", "BL_USE_RX_C03", "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09")

prepare.maaslin(pseq.genus,
                 tsvfile = "maaslin_merged_phfinrisk_genus.tsv",
                conffile = "maaslin_config.config",
                includedvars = c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION", maaslin.force.vars))

Maaslin("maaslin_merged_phfinrisk_genus.tsv",
        "maaslin",
        strInputConfig = "maaslin_config.config",
        strModelSelection="none",
        dSignificanceLevel = 1.0, 
        fAllvAll = TRUE,
        strForcedPredictors = maaslin.force.vars)
```

Reading and filtering the data Maaslin provided

```{r Reading maaslins output}
maas.results.df.signf <- read.table("maaslin/maaslin_merged_phfinrisk_genus.txt", header=TRUE, sep='\t') %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
           beta = Coefficient) %>%
   dplyr::filter(Qval < 0.05) 

maas.signf.features <- maas.results.df.signf %>%
    pull(Feature) %>%
    as.character() %>%
    gsub("_", ".", .)

df.merged <-  merge.pheno.abu(pseq.genus)
```

Table for significant relations between blood pressure variables and genera

```{r maaslin significant table}
maas.results.df.signf %>%
    select(Name, Feature, beta, Qval) %>%
    kable           
```

A scatter plot for the significant genera against blood
pressuer. Compositional data is transformed using 
$\textrm{arcsin}(\textrm{sqrt} (\cdot))$.

```{r maaslin scatter plot, fig.width = 10, fig.height = 20, dpi = 300}
ggplot(df.merged %>% gather(Covariate, relabundance, maas.signf.features), aes(x = asin(sqrt(relabundance)), y = SYSTM)) +
    facet_wrap(~Covariate, ncol=2, scales = "free") +
    geom_point(aes(color = SEX), size = 0.2) +
    scale_y_continuous(breaks=seq(0,200,40)) +
    geom_smooth(method=lm, se=TRUE, size=0.5, color = 'Black') +
    stat_poly_eq(formula = "y ~ x",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 label.y = 0,
                 parse = TRUE,
                 size = 3) +   
    ggplot2::theme_minimal() 
```

```{r maaslin plot, message = FALSE, echo = FALSE}
source("edgeR_plot_functions.R")

plot_maaslin_heatmap_final(maas.results.df.signf,
                      xlab.text="Genera",
                      beta.maxabs=max(abs(maas.results.df.signf[,'beta'])),
                      order.by.category=FALSE)
```

# Lactobacillus

```{r lactobacillus}
pseq.lacto  <- subset_taxa(pseq.species, Genus=="Lactobacillus")
pseq.lacto.comp  <- microbiome::transform(pseq.lacto, "compositional")
abud.rel.lacto <- abundances(pseq.lacto.comp)

abud.rel.lacto %>%
    t %>%
    as.data.frame %>%
    #dplyr::select("Lactobacillus_paracasei (BacteriaPlasmid)", "Lactobacillus_selangorensis (Bacteria)") %>%
    gather(key, value) %>%
    group_by(key) %>%
    summarise_all(funs(mean= mean(value),
                       min = min(value),
                       max = max(value),
                       sd = sd(value),
                       n = n(),
                       nonzeros = sum(abs(value) > 1e-12),
                       zeros = n - nonzeros)) %>%
    arrange(zeros) %>%
    kable
```

```{r lactobacillus scatterplot}
df.merged.lacto <-  merge.pheno.abu(pseq.lacto)

colnames(df.merged.lacto)

prepare.maaslin(pseq.lacto,
                 tsvfile = "maaslin_lacto_merged_phfinrisk_genus.tsv",
                conffile = "maaslin_lacto_config.config",
                includedvars = c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION", maaslin.force.vars),
                readpclrows = "-MAP")

Maaslin("maaslin_lacto_merged_phfinrisk_genus.tsv",
        "maaslin_lacto",
        strInputConfig = "maaslin_lacto_config.config",
        strModelSelection="none",
        dSignificanceLevel = 1.0, 
        fAllvAll = TRUE,
        strForcedPredictors = maaslin.force.vars)

```
