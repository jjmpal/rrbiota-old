---
title: "Hypertension and microbiome"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, echo = TRUE, message = FALSE, results='asis', cache=TRUE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')
```

Importing libraries

```{r libraries}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(finriskmetagcommon)
library(knitr)
library(tidyr)
library(vegan)
library(reshape)
library(ggpmisc)
library(Maaslin)
```

```{r functions, include = FALSE}
print.dset <- function(dset) {
    dset %>%
        gather(Covariate, Value) %>%
        group_by(Covariate) %>%
        summarise_all(., .funs = funs(mean(as.numeric(.), na.rm = TRUE),
                                         median(as.numeric(.), na.rm = TRUE),
                                         sd(as.numeric(.), na.rm = TRUE),
                                         min(as.numeric(.), na.rm = TRUE),
                                         max(as.numeric(.), na.rm = TRUE),
                                         NAs = sum(is.na(.)),
                                         n = n(),
                                         n_distinct)) %>%
            mutate_if(is.numeric, round, 2) %>%
            kable
}
```

Loading phyloseq object

```{r data}
pseq.genus <- readRDS("data/phfinrisk_genus_all_drop50k_2018-11-16.RDs")
pseq.species <- readRDS("data/phfinrisk_species_ok_drop50k_2018-11-16.RDs")
```

Loading descriptions for clinical data

```{r variables}
data("phfinrisk_metadatadesc", package="finriskmetagcommon")
names.dset <- filter(phfinrisk_metadatadesc,
                     Ignored.Covariate.in.Cross.Sectional.Analysis.Aaro20181115==0)
```

Filtering clinical data

```{r filtering}
dset <- meta(pseq) %>%
    tibble::rownames_to_column(var = "rowname") %>%
    dplyr::select(rowname, DNA_OK, MEN, BL_AGE, SYSTM, DIASM, BP_TREAT, BMI, CURR_SMOKE, DIAB, BL_USE_RX_C09,
        Q57X, BL_USE_RX_C03, BL_USE_RX_C07, BL_USE_RX_C08) %>%
    dplyr::mutate(PULSEPRESSURE = SYSTM - DIASM,
                  HYPERTENSION = factor(ifelse(SYSTM >= 140 | DIASM >= 90 | BP_TREAT == 1, 1, 0)),
                  SEX = factor(ifelse(MEN == "Female", 1, 0)),
                  MAP = 2./3.*DIASM + 1./3.*SYSTM) %>%
    dplyr::select(-MEN) %>%
    stats::na.omit() %>%
    tibble::remove_rownames() %>%
    tibble::column_to_rownames(var = "rowname")

print.dset(dset)
```

Continuous variables

```{r distribution plots, fig.width=10, fig.height=4}
ggplot((dset %>%
        select(BL_AGE, BMI, SYSTM, DIASM, PULSEPRESSURE, MAP) %>%
        gather(Covariate, Value)), aes_string(x = "Value")) +
    facet_wrap(~Covariate, ncol=4, scales = "free") +
    geom_density(aes(y=..scaled..)) + 
    ggplot2::theme_minimal() 
```

Categorical variables

```{r histogramsy, fig.width=10, fig.height=4}
ggplot((dset %>%
        select(-BL_AGE, -BMI, -SYSTM, -DIASM, -PULSEPRESSURE, -MAP) %>%
        gather(Covariate, Value)), aes_string(x = "Value")) +
    facet_wrap(~Covariate, ncol=8, scales = "free") +
    geom_bar() + 
    ggplot2::theme_minimal() 
```

```{r Updating meta data}
pseq_filtered <- pseq
sample_data(pseq_filtered) <- sample_data(dset)
```

# Alpha diversity

Dset with alpha diversity

```{r alpha diversity}

alphadiversity <- microbiome::global(pseq_filtered, index="shannon")
dset.alpha <- merge(dset, alphadiversity, by=0, all=TRUE)

```

```{r alpha diversity scatterplot, fig.width=10, fig.height=4}

ggplot((dset.alpha %>%
        select(BL_AGE, BMI, SYSTM, DIASM, PULSEPRESSURE, MAP, SEX, diversities_shannon) %>%
        gather(Covariate, Value, -SEX, -diversities_shannon)), 
       aes(x=diversities_shannon, y=Value)) +
    facet_wrap(~Covariate, ncol=4, scales = "free") +
    geom_point(size=0.1, shape=1, aes(colour = SEX)) +
    geom_smooth(method=lm, se=TRUE, size=0.5, color = 'Black') +
    stat_poly_eq(formula = "y ~ x",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 label.y = 0,
                 parse = TRUE,
                 size = 3) +   
    ylim(0, 200) +
    ggplot2::theme_minimal() 


```

Linear models

```{r lm model}
lm(MAP ~ diversities_shannon, data=dset.alpha) %>%
    summary(.) %>% coef %>% kable(., digits=4)
lm(MAP ~ BL_AGE + SEX + diversities_shannon, data=dset.alpha) %>%
    summary(.) %>% coef %>% kable(., digits=4)
lm(MAP ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + BP_TREAT + diversities_shannon, data=dset.alpha) %>%
    summary(.) %>% coef %>% kable(., digits=4)

```

# Beta diversity

Beetadiversiteetti-matriisin lasku. Tiedosista comp_bc_dissimilarity_matrix.R ja käyttö comp_adonis_covariates.R.

```{r vegdist}

phf_profile.rel <- microbiome::transform(pseq_filtered, 'compositional')
otu <- microbiome::abundances(phf_profile.rel)

if (!file.exists("rds/bray.dist.m.rds")) {
    bray.dist.m <- vegdist(t(otu), method="bray")
    saveRDS(bray.dist.m, file = "rds/bray.dist.m.rds")
} else {
    bray.dist.m <- readRDS("rds/bray.dist.m.rds")
}

dist.matrix <- as.matrix(bray.dist.m)
attr(dist.matrix, "method") <- "bray"

```

```{r beta hclust, fig.width = 5, fig.height = 4, dpi = 300}
gplots::heatmap.2(dist.matrix,
                  distfun = dist,
                  trace = "none",
                  hclustfun = hclust,
                  key.title = NA,
                  dendrogram = "column",
                  density.info = "none",
                  labRow = NA,
                  labCol = NA)
```	

Mallin lasku Adoniksella

```{r adonis1}
adonis(dist.matrix ~ MAP, 
       data = meta(pseq_filtered),
       permutations = 99)$aov.tab %>%
                            as.data.frame %>%
                            kable
```

```{r adonis2}
adonis(dist.matrix ~ BL_AGE + SEX + MAP,
       data = meta(pseq_filtered),
       permutations = 99)$aov.tab %>%
                            as.data.frame %>%
                            kable
```

```{r adonis3}
adonis(dist.matrix ~ MAP + BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + BP_TREAT,
       data = meta(pseq_filtered),
       permutations = 99)$aov.tab %>%
                            as.data.frame %>%
                            kable
```

# PCA

```{r pca}
pseq.clr <- microbiome::transform(pseq_filtered, "clr")
X <- as.matrix(t(abundances(pseq.clr)))
prcomp <- stats::prcomp(X)
```

```{r pca labels}
percentage <- round(prcomp$sdev/sum(prcomp$sdev) * 100, 2)
pca.labels <- paste0(colnames(prcomp$x), " (", paste0(as.character(percentage), "%", ")"))
```

```{r PCA plots categorical, fig.width = 10, fig.height = 10, dpi = 300}
ggplot((cbind(meta(pseq_filtered), prcomp$x[,1:2]) %>%
        select(PC1, PC2, BP_TREAT, CURR_SMOKE, DIAB, BL_USE_RX_C09, Q57X,
               BL_USE_RX_C03, BL_USE_RX_C07, BL_USE_RX_C08, HYPERTENSION, SEX) %>%
        gather(Covariate, Value, -PC1, -PC2)), 
       aes(x=PC1, y=PC2)) +
    facet_wrap(~Covariate, ncol=2, scales = "free") +
    geom_point(aes(color = Value), size = 0.5) +
    scale_color_brewer(palette="Dark2") +
    xlab(pca.labels[1]) +
    ylab(pca.labels[2]) +
    ggplot2::theme_minimal() 

```


```{r PCA plots continuous, fig.width = 10, fig.height = 10, dpi = 300}

ggplot((cbind(meta(pseq_filtered), prcomp$x[,1:2]) %>%
        select(PC1, PC2, BL_AGE, SYSTM, DIASM, BMI, MAP, PULSEPRESSURE) %>%
        gather(Covariate, Value, -PC1, -PC2)), 
       aes(x=PC1, y=PC2)) +
    facet_wrap(~Covariate, ncol=2, scales = "free") +
    geom_point(aes(color = Value), size = 0.5) +
    scale_color_gradientn(colours = rainbow(12)) +
    xlab(pca.labels[1]) +
    ylab(pca.labels[2]) +
    ggplot2::theme_minimal() 

```

# Genus

Aaron work-december-2018 prepare_maaslin_input.R

```{r prepare maaslin}

pheno <- t(meta(sample_data(pseq_filtered)))
sample.ids <- colnames(pheno)
phfg.pseq.rel <- microbiome::transform(pseq_filtered, "compositional")
abud.rel <- abundances(phfg.pseq.rel)

rownames(abud.rel) <- sapply(rownames(abud.rel),
                             function (genus) gsub("(.*) \\(+(.+)\\)", '\\1.\\2', genus))

merged <- rbind(sample.ids, pheno, abud.rel)
write.table(t(merged), file="merged_phfinrisk_genus.tsv", sep='\t', 
            quote=FALSE, row.names=FALSE, col.names=TRUE)

variables <- rownames(pheno)
variables_wo_ctrls <- variables[!variables %in% c("BL_AGE","BMI","SEX")]
data <- file("maaslin_config.config" , open='wt')
pcl.contents <- c("Matrix: Metadata",
                  paste(c("Read_PCL_Rows: BL_AGE,BMI,SEX",variables_wo_ctrls), collapse=","),
                  "",
                  "Matrix: Adundance",
                  "Read_PCL_Rows: Archaea.Archaea-")
writeLines(pcl.contents, con=data)
close(data)
```


```{r run maaslin, eval = FALSE} 
Maaslin("merged_phfinrisk_genus.tsv",
        "maaslin",
        strInputConfig = "maaslin_config.config",
        strModelSelection="none",
        dSignificanceLevel = 1.0, 
        fAllvAll = TRUE,
        strForcedPredictors = c("BL_AGE", "BMI", "SEX"))

```

Data framen luku *comp_maaslin_results_from_single_job.R* ja plottaus käyttäen *comp_maaslin_plots.R* ja *edgeR_plot_functions.R*.


```{r Reading maaslins output}

maas.results.df <- read.table("maaslin/merged_phfinrisk_genus.txt", header=TRUE, sep='\t')
maas.results.df[,'Covariate'] <- maas.results.df[,'Variable']
maas.results.df <- merge(maas.results.df,
                         names.dset[,c('Covariate','Category', 'Name')],
                         by=c('Covariate'))

maas.results.df[,'Maaslin.Q.value'] <- maas.results.df[,'Q.value']
maas.results.df[,'Qval'] <- p.adjust(maas.results.df[,'P.value'], method="BH")
maas.results.df[,'beta'] <- maas.results.df[,'Coefficient']
maas.results.df.signf <- dplyr::filter(maas.results.df, Qval < 0.05)

```

```{r scatter plots}

sysm.signf.features <- maas.results.df.signf %>%
    dplyr::filter(Covariate == "SYSTM") %>%
    pull(Feature) %>%
    as.character() %>%
    gsub("_", ".", .)
df.merged <- t(merged) %>% as.data.frame
```

```{r maaslin scatter plot, fig.width = 10, fig.height = 20, dpi = 300}

#df.merged %>% pull("Rikenella.Bacteria") %>% as.character I%>% as.numeric %>% sqrt %>% asin

ggplot(df.merged %>%
       select(sysm.signf.features, SYSTM, SEX) %>%
       gather(Covariate, Value, sysm.signf.features) %>%
       mutate(SYSTM = as.numeric(as.character(SYSTM)),
              Value = as.numeric(as.character(Value))),
       aes(x = asin(sqrt(Value)), y = SYSTM)) +
    facet_wrap(~Covariate, ncol=2, scales = "free") +
    geom_point(aes(color = SEX), size = 0.5) +
    scale_y_continuous(breaks=seq(0,200,40)) +
    geom_smooth(method=lm, se=TRUE, size=0.5, color = 'Black') +
    stat_poly_eq(formula = "y ~ x",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 label.y = 0,
                 parse = TRUE,
                 size = 3) +   
    ggplot2::theme_minimal() 


```


```{r maaslin plots, fig.width = 10, fig.height = 4, dpi = 300}
source("edgeR_plot_functions.R")

plot_maaslin_heatmap_final(maas.results.df.signf,
                      xlab.text="Genera",
                      beta.maxabs=max(abs(maas.results.df.signf[,'beta'])))

```


```{r scp html}
system('scp rrbiome.html utu:articletwo')
```
