---
title: "Hypertension and microbiome"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, echo = TRUE, message = FALSE, results='asis', cache=TRUE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')
```

Importing libraries

```{r libraries}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(finriskmetagcommon)
library(knitr)
library(tidyr)
library(vegan)
library(reshape)
library(ggpmisc)
library(Maaslin)
```

```{r functions, include = FALSE}
print.dset <- function(dset) {
    dset %>%
        gather(Covariate, Value) %>%
        group_by(Covariate) %>%
        summarise_all(., .funs = funs(mean(as.numeric(.), na.rm = TRUE),
                                         median(as.numeric(.), na.rm = TRUE),
                                         sd(as.numeric(.), na.rm = TRUE),
                                         min(as.numeric(.), na.rm = TRUE),
                                         max(as.numeric(.), na.rm = TRUE),
                                         NAs = sum(is.na(.)),
                                         n = n(),
                                         n_distinct)) %>%
            mutate_if(is.numeric, round, 2) %>%
            kable
}

filter.phenotype.data <- function(pseq,
                                  included = c("DNA_OK", "MEN", "BL_AGE", "SYSTM", "DIASM", "BP_TREAT", "BMI",
                                               "CURR_SMOKE", "DIAB", "BL_USE_RX_C09", "Q57X", "BL_USE_RX_C03",
                                               "BL_USE_RX_C07", "BL_USE_RX_C08"))
    meta(pseq) %>%
        tibble::rownames_to_column(var = "rowname") %>%
        dplyr::select(rowname, included) %>% 
        dplyr::mutate(ANYDRUG = factor(ifelse(BL_USE_RX_C03  == 1 | BL_USE_RX_C07 == 1 |
                                       BL_USE_RX_C08 == 1  | BL_USE_RX_C09 == 1, 1, 0)),
                      ANYEXERCICE = factor(ifelse(Q57X == 1, 0, 1)),
                      PULSEPRESSURE = SYSTM - DIASM,
                      HYPERTENSION = factor(ifelse(SYSTM >= 140 | DIASM >= 90 | ANYDRUG == 1, 1, 0)),
                      SEX = factor(ifelse(MEN == "Female", 1, 0)),
                      MAP = 2./3.*DIASM + 1./3.*SYSTM) %>%
 #       dplyr::filter(DNA_OK == 1) %>%
        stats::na.omit() %>%
        dplyr::select(-MEN, -DNA_OK) %>%
        tibble::remove_rownames() %>%
        tibble::column_to_rownames(var = "rowname")
```

Loading descriptions for clinical data

```{r variables}
data("phfinrisk_metadatadesc", package="finriskmetagcommon")
names.dset <- filter(phfinrisk_metadatadesc,
                     Ignored.Covariate.in.Cross.Sectional.Analysis.Aaro20181115==0)
```

Loading phyloseq object

```{r data}
pseq.genus <- readRDS("data/phfinrisk_genus_all_drop50k_2018-11-16.RDs")
pseq.species <- readRDS("data/phfinrisk_species_all_drop50k_2018-12-21.RDs")
```

Filtering clinical data

```{r filtering}
dset.genus <- filter.phenotype.data(pseq.genus)
dset.species <- filter.phenotype.data(pseq.species)
```

Phenotypical data between genus and species all.equal `r 
isTRUE(all.equal(dset.genus, dset.species))`. Dimension for data
frames are (`r dim(dset.genus)`) and (`r dim(dset.species)`).

Updating phyloseq objects

```{r updating phyloseq objects}
pseq.genus <- sample_data(dset.genus)
pseq.species <- sample_data(dset.species)
```

# How large subgroups are?

Number of participants in each combination of all categorical variables

```{r numbers by group}
dset.species %>%
    group_by(SEX, CURR_SMOKE,  HYPERTENSION, Q57X,
             BL_USE_RX_C09, BL_USE_RX_C03, BL_USE_RX_C07, BL_USE_RX_C08) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    kable            
```

Number of particiapants in each combination after combining RR
medication and exercice to binomial variables.

```{r numbers by group reduced}
dset.species %>%
     group_by(SEX, CURR_SMOKE,  HYPERTENSION, ANYDRUG, ANYEXERCICE) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    kable
```

# Self reported vs. registered medication

Contigency table for RR mediaction. P-value for chi-squared test is
`r chisq.test(dset.species$BP_TREAT, dset.species$ANYDRUG, correct=FALSE)$p.value %>% format.pval`.

```{r self vs registered medication}
table(dset.species$BP_TREAT, dset.species$ANYDRUG)  %>%
    kable
```




```{r scp html, cache = FALSE}
system('scp rrbiome.html utu:articletwo')
```
