---
title: "Hypertension and microbiome"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis', cache=FALSE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

dir.create("rds/", showWarnings = FALSE)
```

Importing libraries:

```{r libraries}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(finriskmetagcommon)
library(knitr)
library(tidyr)
library(vegan)
library(reshape)
library(ggpmisc)
library(Maaslin)
library(parallel)
```

## RR biome functions

```{r RR biome functions, code=readLines("articletwo-rrbiome.R")}
source("articletwo-rrbiome.R")
```

# Loading data
	
Loading descriptions for clinical data

```{r variables}
data("phfinrisk_metadatadesc", package="finriskmetagcommon")
names.dset <- filter(phfinrisk_metadatadesc,
                     Ignored.Covariate.in.Cross.Sectional.Analysis.Aaro20181115==0)
names.dset <- bind_rows(names.dset,
                        data.frame(Covariate = c("MAP", "PULSEPRESSURE", "HYPERTENSION"),
                                   Category = rep("Physical", 3),
                                   Name =c( "Mean artrerial pressure", "Pulse pressure", "Hypertension")))
```

Loading phyloseq object

```{r data}
pseq.genus <- readRDS("data/phfinrisk_genus_all_drop50k_2018-11-16.RDs")
pseq.species <- readRDS("data/phfinrisk_species_all_drop50k_2018-12-21.RDs")
```

Filtering clinical data

```{r filtering}
dset.genus <- filter.phenotype.data(pseq.genus)
dset.species <- filter.phenotype.data(pseq.species)
```

Phenotypical data between genus and species all.equal `r 
isTRUE(all.equal(dset.genus, dset.species))`. Dimension for data
frames are (`r dim(dset.genus)`) and (`r dim(dset.species)`).

Updating phyloseq objects

```{r updating phyloseq objects}
phyloseq::sample_data(pseq.genus) <- phyloseq::sample_data(dset.genus)
phyloseq::sample_data(pseq.species) <- phyloseq::sample_data(dset.species)
```

Sample data has dimensions (`r dim(sample_data(pseq.species))`).

# Self reported vs. registered medication

Contigency table for RR mediaction. 

```{r self vs registered medication}
tbl <- table(dset.species$BP_TREAT, dset.species$ANYDRUG)
colnames(tbl) <- c("ANYDRUG 0", "ANYDRUG 1")
rownames(tbl) <- c("BP_TREAT 0", "BP_TREAT 1")
tbl %>%
    kable(.)
```

$\chi^2$-test for medication `r format.pval(chisq.test(dset.species$BP_TREAT, dset.species$ANYDRUG, correct=FALSE)$p.value)`.

# How large subgroups are?

Number of participants in each combination of all categorical variables

```{r numbers by group}
dset.species %>%
    group_by(SEX, CURR_SMOKE,  HYPERTENSION, Q57X, DIAB,
             BL_USE_RX_C09, BL_USE_RX_C03, BL_USE_RX_C07, BL_USE_RX_C08) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    kable            
```

Number of particiapants in each combination after combining RR
medication and exercice to binomial variables.

```{r numbers by group reduced}
dset.species %>%
     group_by(SEX, CURR_SMOKE,  HYPERTENSION, DIAB, ANYDRUG, ANYEXERCICE) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>%
    kable
```

# Alpha diversity

Dset with alpha diversity

```{r alpha diversity}
dset.alpha <- meta.merge.alphadiversity(pseq.species)
```

Scatterplots for alpha diversity by age group and sex.

```{r alpha-MAP scatter plots, fig.width=10, fig.height=15}
ggplot(dset.alpha %>% mutate(SEX = ifelse(SEX == 0, "Male", "Female")), aes(x=diversities_shannon, y=MAP)) +
    facet_wrap(~BL_AGE_GROUP + SEX, ncol=2, scales = "free") +
    geom_point(size=0.1, shape=1, aes(colour = ANYDRUG)) +
    scale_colour_manual(values = c("red","blue", "green")) +
    geom_smooth(method=lm, se=TRUE, size=0.5, color = 'Black') +
    stat_poly_eq(formula = "y ~ x",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 label.y = 0,
                 parse = TRUE,
                 size = 3) +   
    ylim(0, 200) +
    ggplot2::theme_minimal() 
```

Calculating linear models for alpha diversity.

```{r calculate full alpha model}
alphaglm <- calculateglm(dset.alpha, modelstring = "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09  + diversities_shannon")
alphaglm %>%
    select(response, estimate, std.error, conf.low, conf.high, p.value) %>%
    kable(.)
```


# Beta diversity

Calculating the distance matrix from data after compositional
transformation using vegdist and bray method.

```{r matrix calculation}
if (!file.exists("rds/bray.dist.m.species.rds") || !file.exists("rds/bray.dist.m.genus.rds")) {
    bray.dist.m.species <- calculate.beta.matrix(pseq.species)
    saveRDS(bray.dist.m.species, file = "rds/bray.dist.m.species.rds")
} else {
    bray.dist.m.species  <- readRDS("rds/bray.dist.m.species.rds")
}
```

Calculating beta diversity for blood pressure variables using adonis

 ```{r adonis calculation}
 if (!file.exists("rds/adonis.species.rds")) {

     adonis.species = list()
     adonis.species$min <- calculateadonis(dset = meta(pseq.species),
                                           matrix = bray.dist.m.species,
                                           covariates = c("BL_AGE", "SEX"),
                                           npermutations = 99)

     adonis.species$max <- calculateadonis(dset = meta(pseq.species),
                                           matrix = bray.dist.m.species,
                                           covariates = c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB", "BL_USE_RX_C03", "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09"),
                                           npermutations = 99)
     saveRDS(adonis.species, file = "rds/adonis.species.rds")
    } else {
     adonis.species  <- readRDS("rds/adonis.species.rds")
}
```                     

Printing the results for adonis run for blood pressure variables in
full model

```{r adonis3}
adonis.species %>%
    data.table::rbindlist(id = "model_name") %>%
#    dplyr::filter(term %in% c("SY) %>%
 #   dplyr::select(-term) %>%
    select(response, SumsOfSqs, MeanSqs, F.Model, R2, "Pr(>F)") %>%
    kable(.)
```

# PCA

We calculate principal component analysis using centered log-ratio
transformation for the abunances.

```{r pca}
if (!file.exists("rds/pca.prcomp.rds")) {
    pca.abundances  <- as.matrix(t(microbiome::abundances(microbiome::transform(pseq.species, "clr"))))
    pca.prcomp <- stats::prcomp(pca.abundances)
    saveRDS(pca.prcomp, file = "rds/pca.prcomp.rds")
} else {
    pca.prcomp <- readRDS("rds/pca.prcomp.rds")
}
```

Proportion of variance for main PC axis

```{r pca percentage}
pca.eigs <- pca.prcomp$sdev^2
pca.percentage <- 100 * pca.eigs /sum(pca.eigs)
pca.labels <- sprintf("%s (%.2f %%)", colnames(pca.prcomp$x), pca.percentage)
setNames(pca.percentage, pca.prcomp$x %>% colnames) %>% head(10) %>% t %>% kable
```

PCA plot for hypertension

```{r PCA plots continuous, fig.width = 10, fig.height = 6, dpi = 300}
ggplot(cbind(meta(pseq.species), pca.prcomp$x[,1:2]), aes(x=PC1, y=PC2)) +
    geom_point(aes(color = HYPERTENSION), size = 0.2) +
    xlab(pca.labels[1]) +
    ylab(pca.labels[2]) +
    scale_color_brewer(palette="Dark2") +
    ggplot2::theme_minimal() 
```

# Connection between genus and blood pressure

Running maaslin for blood pressure variables while rest of the
phenotype variables are forced in the model

```{r run maaslin, results = 'hide'} 
maaslin.force.vars <- c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB", "BL_USE_RX_C03", "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09")

prepare.maaslin(pseq.genus,
                 tsvfile = "maaslin_core_merged_phfinrisk_genus.tsv",
                conffile = "maaslin_core_config.config",
                includedvars = c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION", maaslin.force.vars),
                core = TRUE,
                readpclrows = "Halapricum.Archaea-")

Maaslin("maaslin_core_merged_phfinrisk_genus.tsv",
        "maaslin_core",
        strInputConfig = "maaslin_core_config.config",
        strModelSelection="none",
        dSignificanceLevel = 1.0, 
        fAllvAll = TRUE,
        strForcedPredictors = maaslin.force.vars)
```

Reading and filtering the data Maaslin provided

```{r Reading maaslins output}
maas.results.df.signf <- read.table("maaslin_core/maaslin_core_merged_phfinrisk_genus.txt", header=TRUE, sep='\t') %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
           beta = Coefficient) %>%
   dplyr::filter(Qval < 0.05) 

maas.signf.features <- maas.results.df.signf %>%
    pull(Feature) %>%
    as.character() %>%
    gsub("_", ".", .)

df.merged <-  merge.pheno.abu(pseq.genus, core = TRUE)
```

Table for significant relations between blood pressure variables and genera

```{r maaslin significant table}
maas.results.df.signf %>%
    select(Name, Feature, beta, Qval) %>%
    kable           
```

A scatter plot for the significant genera against blood
pressuer. Compositional data is transformed using 
$\textrm{arcsin}(\textrm{sqrt} (\cdot))$.

```{r maaslin scatter plot, fig.width = 10, fig.height = 20, dpi = 300}
ggplot(df.merged %>% gather(Covariate, relabundance, maas.signf.features), aes(x = asin(sqrt(relabundance)), y = SYSTM, color = SEX)) +
    facet_wrap(~Covariate, ncol=2, scales = "free") +
    geom_point(size = 0.2) +
    scale_y_continuous(breaks=seq(0,200,40)) +
    geom_smooth(method=lm, se=TRUE, size=0.5) +
    stat_poly_eq(formula = "y ~ x",
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 label.y.npc = "bottom",
                 label.x.npc = "right",
                 parse = TRUE,
                 size = 3) +   
    ggplot2::theme_minimal() 
```

```{r maaslin plot, message = FALSE, echo = FALSE}
source("aaro/edgeR_plot_functions.R")

plot_maaslin_heatmap_final(maas.results.df.signf %>% dplyr::filter(Variable != "HYPERTENSION"),
                      xlab.text="Genera",
                      beta.maxabs=max(abs(maas.results.df.signf[,'beta'])),
                      order.by.category=FALSE)
```

# Lactobacillus

```{r lactobacillus}
pseq.lacto  <- subset_taxa(pseq.species, Genus=="Lactobacillus")
pseq.lacto.comp  <- microbiome::transform(pseq.lacto, "compositional")
abud.rel.lacto <- abundances(pseq.lacto.comp)

abud.rel.lacto %>%
    t %>%
    as.data.frame %>%
    #dplyr::select("Lactobacillus_paracasei (BacteriaPlasmid)", "Lactobacillus_selangorensis (Bacteria)") %>%
    gather(key, value) %>%
    group_by(key) %>%
    summarise_all(funs(mean= mean(value),
                       min = min(value),
                       max = max(value),
                       sd = sd(value),
                       n = n(),
                       nonzeros = sum(abs(value) > 1e-12),
                       zeros = n - nonzeros)) %>%
    arrange(zeros) %>%
    kable
```

```{r lactobacillus scatterplot, eval = FALSE, include = FALSE}
maaslin.force.vars <- c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB", "BL_USE_RX_C03", "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09")

prepare.maaslin(pseq.lacto,
                 tsvfile = "maaslin_lacto_merged_phfinrisk_genus.tsv",
                conffile = "maaslin_lacto_config.config",
                includedvars = c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION", maaslin.force.vars),
                readpclrows = "Lactobacillus_delbrueckii.Bacteria,Lactobacillus_ruminis.Bacteria,Lactobacillus_acidophilus.Bacteria,Lactobacillus_fermentum.Bacteria,Lactobacillus_paracasei.Bacteria,Lactobacillus_salivarius.Bacteria")

Maaslin("maaslin_lacto_merged_phfinrisk_genus.tsv",
        "maaslin_lacto",
        strInputConfig = "maaslin_lacto_config.config",
        strModelSelection="none",
        dSignificanceLevel = 1.0, 
        fAllvAll = TRUE,
        strForcedPredictors = maaslin.force.vars)
```

```{r Reading maaslin lacto output, eval = FALSE, include = FALSE}
maas.lacto.results.df.signf <- read.table("maaslin_lacto/maaslin_lacto_merged_phfinrisk_genus.txt", header=TRUE, sep='\t') %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
                  beta = Coefficient) %>%
   dplyr::filter(Qval < 0.05) 

maas.lacto.signf.features <- maas.results.df.signf %>%
    pull(Feature) %>%
    as.character() %>%
    gsub("_", ".", .)

df.lacto.merged <-  merge.pheno.abu(pseq.lacto)
```

```{r maaslin lacto significant table, eval = FALSE, include = FALSE}
maas.lacto.results.df.signf %>%
    select(Name, Feature, beta, Qval) %>%
    kable           
```
