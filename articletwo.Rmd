---
title: "Hypertension and microbiome"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis', cache=TRUE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

dir.create("rds/", showWarnings = FALSE)
```

# Running at

Calculations ran at

```{r Running at}
if (!exists('now')) {
    now <- format(Sys.time(), '%Y%m%d-%H%M%S')
}
now
```

Session info

```{r session info}
sessionInfo()
```

# Importing libraries:

```{r libraries, cache = FALSE}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(finriskmetagcommon)
library(knitr)
library(tidyr)
library(vegan)
library(reshape)
library(ggpmisc)
library(Maaslin)
library(parallel)
library(officer)
library(flextable)
library(rvg)
library(tableone)
library(scales)
library(gridExtra)
library(png)
```

```{r Remove temporary data, include = FALSE, cache = FALSE, eval = FALSE}
unlink("rds", recursive=TRUE)
unlink("cache", recursive=TRUE)
```

```{r Initialize docx, include = FALSE, cache = FALSE}
doc <- read_docx(path = "style/articlestyle.docx") %>%
  body_remove()
dir.create("rds", showWarnings = FALSE)
dir.create("cache", showWarnings = FALSE)
```

# Sources

### Officer functions

```{r Officer importer, code=readLines("articleone-officer.R")}
source("articletwo-officer.R")
```

### RR biome functions

```{r RR biome functions, code=readLines("articletwo-rrbiome.R")}
source("articletwo-rrbiome.R")
```

### EdgeR plot functions

```{r EdgeR functions, code=readLines("aaro/edgeR_plot_functions.R")}
source("aaro/edgeR_plot_functions.R")
```

# Loading data
	
Loading descriptions for clinical data

```{r variables, warning = FALSE}
data("phfinrisk_metadatadesc", package="finriskmetagcommon")
names.dset <- filter(phfinrisk_metadatadesc,
                     Ignored.Covariate.in.Cross.Sectional.Analysis.Aaro20181115==0)
names.dset <- bind_rows(names.dset,
                        data.frame(Covariate = c("MAP", "PULSEPRESSURE", "HYPERTENSION", "SEX"),
                                   Category = rep("Physical", 4),
                                   Name =c( "Mean artrerial pressure", "Pulse pressure", "Hypertension", "Female"),
                                   Desc = c("Mean arterail presure, 2./3.*DIASM + 1./3.*SYSTM)",
                                            "Pulse pressure, SYSTM - DIASM",
                                            "Hypertension, SYSTM >=140 or DIAS >= 90 or BP mediaction",
                                            "Sex is female, True for female, False for male")))
```

Loading phyloseq object

```{r data}
pseq.genus <- readRDS("data/phfinrisk_genus_all_drop50k_2018-11-16.RDs")
pseq.species <- readRDS("data/phfinrisk_species_all_drop50k_2018-12-21.RDs")
```

Updating phyloseq objects

```{r updating phyloseq objects}
phyloseq::sample_data(pseq.genus) <- phyloseq::sample_data(filter.phenotype.data(pseq.genus))
phyloseq::sample_data(pseq.species) <- phyloseq::sample_data(filter.phenotype.data(pseq.species))
```

Sample data has dimensions (`r dim(sample_data(pseq.species))`).

## Characteristics of the study sample. (Table 1.)

```{r Characteristics}
tbl1 <- tableone(meta(pseq.species))
```

```{r Write characteristics}
tbl1head <- "Characteristics of the study sample."
tbl1foot <- "Continuous variables are presented as mean (standard deviation). Exercise at free-timeis reported as not much (1), walk etc. (2), regular three hours or more or competitive sports (3). Categorical variables reported as absolute and relative frequencies. BP indicates blood pressure, BMI body mass index, RAS renin-angiotensin system."
writetable(doc, tbl1, number = 1, tbl1head, tbl1foot)
```

## Alpha & Beta plot (Figure 1.)

```{r alphabeta definitions}
dset.alpha <- meta.merge.alphadiversity(pseq.species)
alphaglm <- calculateglm(dset.alpha, modelstring = "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09  + diversities_shannon")
alpha.diversity <- alphaglm %>% select(response, estimate, p.value)

adonis.species  <- readRDS("rds/adonis.species.rds")

beta.diversity <- adonis.species %>%
    data.table::rbindlist(id = "model_name") %>%
    dplyr::filter(term %in% c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION"))

                                        #%>%
    dplyr::select(response, R2)

diversity <- merge(alpha.diversity, beta.diversity, by = "response") %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="response", by.y = "Covariate") %>%
    mutate(Qstar = ifelse(p.value < 0.05, '*', ' '))

fig.height <- 4.0 + nrow(diversity) * 0.33
fig.permar2.text <- "R2 of variable \nin Bray-Curtis distance" # TODO latexify expression?
fig.textsize <- 15
amaxb <- diversity %>% pull(estimate) %>% abs %>% max %>% signif(., digits = 2)
```

```{r alphabeta alpha}
plot.alpha.diversity <- ggplot(diversity, aes(x=reorder(Name, R2),  y = 1, fill = estimate)) +
    geom_bar(stat="identity", color="black") +
    coord_flip() +
    scale_fill_gradientn(colours = c("darkblue", "blue", "white", "red", "darkred"),
                         values = rescale(c(-amaxb,-0.1, 0, 0.1, amaxb)),
                         name = 'Regression coefficient \nin linear model \nfor Shannon index',
                         limits = c(-1.05*amaxb, 1.05*amaxb),
                         na.value = "black") +
    theme_classic(20) +
    geom_point(aes(Name, y=0.5, shape=Qstar), show.legend=TRUE, color='black', size=20) +
    scale_shape_manual(name="",
                       values=c('*'='*', ' '=' '),
                       labels=c("*"="significant at FDR 0.05", ' '=' '),
                       breaks=c("*", ' ')) +
    xlab("") +
    ylab("") +
    theme(legend.position="right",
          legend.title=element_text(size = 20),
          legend.direction="vertical",
          legend.text=element_text(size = floor(0.75*20)),
          legend.box.margin=margin(0,0,0,0,"pt"),
          legend.margin=margin(0,0,0,0,"pt"),
          legend.justification="left",
          axis.line.y = element_line(linetype="blank"),
          axis.line.x = element_line(linetype="blank"),
          legend.title.align = 0,
          legend.text.align = 0,
          axis.text.y = element_text(color="black"),
          axis.text.x = element_text(color="black"))+
    scale_y_continuous(breaks=c(0.5), labels=c(expression(alpha)))

plot.alpha.diversity.gtable <- ggplot_gtable(ggplot_build(plot.alpha.diversity))
plot.alpha.diversity.legend <- legend_extractor(plot.alpha.diversity.gtable)
plot.alpha.diversity.yaxis <- plot.alpha.diversity.gtable$grobs[[3]]

plot.alpha.diversity <- plot.alpha.diversity +
    theme(legend.position = "none",
          axis.text.x = element_blank(),
          axis.text.y=element_blank())

plot.gtable.alpha.diversity.stripped <- ggplot_gtable(ggplot_build(plot.alpha.diversity))
```


```{r alphabeta beta}
plot.beta.diversity <- ggplot(diversity, aes(x = reorder(Name, R2), y= R2)) +
    geom_bar(stat="identity", color='black') +
    coord_flip() +
    theme_classic(fig.textsize) +
    ylab(fig.permar2.text) +
    theme(axis.text.y = element_text(color="black"),
          axis.text.x = element_text(color="black"),
          legend.position="right",
          legend.direction="vertical",
          legend.box.margin=margin(0,0,0,0,"pt"),
          legend.margin=margin(0,0,0,0,"pt"),
          legend.justification="left",
          legend.title.align = 0,
          legend.text.align = 0)

plot.gtable.beta.diversity <- ggplot_gtable(ggplot_build(plot.beta.diversity))
plot.xlab.beta.diversity <- xlabb_extractor(gtable.beta.diversity)

plot.beta.diversity <- plot.beta.diversity  +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.title.x  =  element_blank(),
          axis.title.y = element_blank(),
          legend.position = "none")
plot.gtable.beta.diversity.stripped <- ggplot_gtable(ggplot_build(plot.beta.diversity))
```


```{r save grob}
gs4 <- list(plot.alpha.diversity.yaxis,
            plot.gtable.alpha.diversity.stripped$grobs[[6]],
            plot.gtable.beta.diversity.stripped$grobs[[6]],
            plot.alpha.diversity.legend,
            plot.alpha.diversity.gtable$grobs[[7]],
            plot.gtable.beta.diversity$grobs[[7]],
           plot.xlab.beta.diversity)
#           plot.gtable.beta.diversity.stripped[[3]])

g4 <- arrangeGrob(grobs = gs4,
            layout_matrix = rbind(
                c(1,2,8,3,NA),
                c(1,2,8,3,4),
                c(1,2,8,3,NA),
                c(1,2,8,3,NA),
                c(NA,5,NA,6,NA),
                c(NA,NA,NA,7,NA)),
            widths=c(4,0.7,0.5,5,5),
            heights=c(3,12,8,21,1,2))

ggsave(file = "cache/alpha-beta.png", plot=g4, height=fig.height, width=11)

```

## Principal component analysis (Figure 2.)

```{r pca}
pca.prcomp <- readRDS("rds/pca.prcomp.rds")
pca.eigs <- pca.prcomp$sdev^2
pca.percentage <- 100 * pca.eigs /sum(pca.eigs)
pca.labels <- sprintf("%s (%.2f %%)", colnames(pca.prcomp$x), pca.percentage)

pcaplot <- ggplot(cbind(meta(pseq.species), pca.prcomp$x[,1:2]), aes(x=PC1, y=PC2)) +
    geom_point(aes(color = HYPERTENSION), size = 0.5) +
    scale_color_manual(values=c("blue", "red"),
                       name= "Hypertension",
                       breaks=c("1", "0"),
                       labels=c("Yes", "No")) +
    xlab(pca.labels[1]) +
    ylab(pca.labels[2]) +
    coord_fixed() +
    scale_x_continuous(breaks=seq(-100, 100, 20)) +
    scale_y_continuous(breaks=seq(-30, 30, 10)) +
    theme_classic() +
    theme(text = element_text(size=20),
          legend.justification=c(1,0),
          legend.position=c(1.03, 0.75),
          legend.title=element_text(size = 20),
          legend.direction="vertical",
          legend.text=element_text(size = floor(0.75*20)),
          legend.box.margin = margin(1, 1, 1, 1, "mm"),
          legend.box.background = element_rect(colour = "black"))

ggsave(file = "cache/pca.png", plot = pcaplot, height = 5, width = 9, dpi = 300)

writeimage(doc, 2, "cache/pca.png", "Alpha-beta", "footer", width = 7)
```

```{r Write figure 2}
fig2head <- "Tenth of bacterial variation can be explained by two first principal axes"
fig2foot <- sprintf("Principal component analysis for bacterial abundances at species level. Centered log ratio transform is performed for the compositional data. First two axes explain %.1f%% of the variation. Research participants with hypertension are denoted by red dot.", sum(pca.percentage[1:2]))
writeimage(doc, 2, "cache/pca.png", fig2head, fig2foot)
```

## Direct associations between genus level and blood pressure variables (figure 3)

```{r maaslin}
maas.results.df.signf <- read.table("maaslin_core/maaslin_core_merged_phfinrisk_genus.txt", header=TRUE, sep='\t') %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
           beta = Coefficient) %>%
   dplyr::filter(Qval < 0.05) 

maaslinplot <- plot_maaslin_heatmap_final(maas.results.df.signf %>% dplyr::filter(Variable != "HYPERTENSION"),
                      xlab.text="Genera",
                      beta.maxabs=max(abs(maas.results.df.signf[,'beta'])),
                      order.by.category=FALSE)

ggsave(file = "cache/maaslin.png", plot = maaslinplot, height = 3, width = 7, dpi = 300)
```

```{r Write figure 3}
fig3head <- ""
fig3foot <- ""
writeimage(doc, 3, "cache/maaslin.png", fig3head, fig3foot)
```


## Figure 4

```{r PCA heatmap}
pca.axis <- pca.prcomp$x %>% data.frame
pca.dset <- base::merge(meta(pseq.species), pca.axis[,1:5], by=0, all=TRUE) %>%
  dplyr::rename(Sample_ID = Row.names)

pca.dset %>% head

pca.ret <- lapply(paste0("PC", seq(1,5)), function (pc) {
    calculateglm(pca.dset,
                 modelstring = paste("%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09  +", pc),
                 filterstr = "PC") %>%
        select(response, estimate, p.value) %>%
        mutate(model_name = pc)
})

pca.ret  %>%
    data.table::rbindlist() %>%
    as.data.frame %>%
    mutate(p.value = p.adjust(p.value, method="BH")) %>%
    arrange(p.value) %>%
    kable
```

## Loadings for principal component axis 3 (Figure 5)

```{r Main contributors of PC3}
pca.rotation.abs <- abs(pca.prcomp$rotation)
pca.loading <- sweep(pca.rotation.abs, 2, colSums(pca.rotation.abs), "/") %>%
    as.data.frame %>%
    tibble::rownames_to_column(var = "term")

pca.prcomp$rotation %>% length

pca.loading %>% pull(PC3) %>% sum

pca.pc3 <- pca.loading %>%
    select(term, PC3) %>%
    arrange(-PC3) %>%
    head(20)



pca.pc3.gg <- ggplot(data=pca.pc3, aes(x=reorder(term, -PC3), y=PC3)) +
    geom_bar(stat="identity") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
   
ggsave(file = "cache/pca.pc3.png", plot = pca.pc3.gg, height = 3, width = 7, dpi = 300)
```

```{r Write figure 4}
fig4head <- ""
fig4foot <- ""
writeimage(doc, 4, "cache/pca.pc3.png", fig4head, fig4foot)
```

```{r Write docx to file, cache = FALSE, results = FALSE, include = FALSE}
print(doc, target = paste0("report/articletwo-", now, ".docx"))
```
