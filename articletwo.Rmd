---
title: "Hypertension and microbiome"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis',
                      cache=FALSE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

options(max.print=100)

dir.create("rds/", showWarnings = FALSE)
dir.create("session/", showWarnings = FALSE)
```

# Command line arguments

Calculations ran at

```{r Command line arguments}
now <- format(Sys.time(), '%Y%m%d-%H%M%S')

if (exists("args")) {
    if ("time" %in% names(args)) now <- args$time
    
    if("clean" %in% names(args)) {
        unlink("rds", recursive=TRUE)
        unlink("cache", recursive=TRUE)
    }
    if ("tags" %in% names(args)) 
        rtags('~/phd/research/articletwo/', recursive = FALSE, pattern = '\\.[RrSs](rw|md)?$',
              ofile = '~/phd/research/articletwo/TAGS', verbose = TRUE, append = FALSE)
    if ("loadlast" %in% names(args) )
        load(paste0("session/", sort(list.files("session"), decreasing = TRUE)[1]))
    if ("subset" %in% names(args))
        subset.run <- as.numeric(args$subset)
}

#packrat::opts$ignored.packages
```


# Importing libraries:

```{r libraries, cache = FALSE}
library(dplyr)
library(tibble)
library(phyloseq)
library(nortest)
library(microbiome)
library(knitr)
library(tidyr)
library(vegan)
library(reshape)
library(parallel)
library(officer)
library(flextable)
library(xtable)
library(rvg)
library(tableone)
library(scales)
library(ggplot2)
library(gridExtra)
library(png)
library(pander)
library(ggpubr)
library(broom)
library(ggfortify)
library(RColorBrewer)
library(gvlma)
library(purrr)
library(pwr)
library(gtable)
library(car)
```

Session info
 
```{r Session info}
pander(sessionInfo(), compact = TRUE)
```

```{r Initialize docx, include = FALSE, cache = FALSE}
doc <- read_docx(path = "style/articlestyle.docx") %>%
  body_remove()
dir.create("rds", showWarnings = FALSE)
dir.create("cache", showWarnings = FALSE)
```

# Sources

### Officer functions

<details>
  <summary>Open/Close</summary>

```{r Officer importer, code=readLines("articletwo-officer.R")}
source("articletwo-officer.R")
```

</details>

### RR biome functions

<details>
  <summary>Open/Close</summary>
  
```{r RR biome functions, code=readLines("articletwo-rrbiome.R")}
source("articletwo-rrbiome.R")
```

</details>


### Plot functions

<details>
  <summary>Open/Close</summary>

```{r Plot functions, code=readLines("articletwo-ggplot.R")}
source("articletwo-ggplot.R")
```

</details>


# Loading data
	
Loading descriptions for clinical data

```{r variables, warning = FALSE}
names.dset <- getdescriptions()
```

Loading phyloseq object

```{r data}
pseq.genus <- import_filter_data("data/phfinrisk_centrifuge_genus_d50k_2019-06-02.rds")
pseq.species <- import_filter_data("data/phfinrisk_centrifuge_species_all_drop50k_2018-11-30_2019-06-03.RDs")
```

At species level meta has dimensions (`r dim(meta(pseq.species))`) and
there ntaxa is `r ntaxa(pseq.species)`, and at genus level meta has
dimensions (`r dim(meta(pseq.genus))`) and there ntaxa is 
`r ntaxa(pseq.genus)`.

## Variables

```{r my variables}
var.BP <- c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION")
var.CL.min <- c("BL_AGE", "SEX")
var.CL <- c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB",
            "BL_USE_RX_C03","BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09")
```

## MODELS

```{r matrix calculation}
if (!file.exists("rds/bray.dist.m.species.rds")) {
    bray.dist.m.species <- calculate.beta.matrix(pseq.species)
    saveRDS(bray.dist.m.species, file = "rds/bray.dist.m.species.rds")
} else {
    bray.dist.m.species  <- readRDS("rds/bray.dist.m.species.rds")
}
```

 ```{r adonis calculation}
 if (!file.exists("rds/adonis.species.rds")) {
     adonis.species = list()
     adonis.species$min <- calculateadonis(dset = meta(pseq.species),
                                           matrix = bray.dist.m.species,
                                           covariates = var.CL.min,
                                           npermutations = 9999)
     adonis.species$max <- calculateadonis(dset = meta(pseq.species),
                                           matrix = bray.dist.m.species,
                                           covariates = var.CL,
                                           npermutations = 9999)
     saveRDS(adonis.species, file = "rds/adonis.species.rds")
 } else {
     adonis.species  <- readRDS("rds/adonis.species.rds")
 }
```

```{r quit subruns, include = FALSE}
if (exists("subset.run")) {
    quit()
}
```

```{r pcoa calculate}
if (!file.exists("rds/pcoa.ordinate.rds")) {
    pcoa.abundances <- microbiome::transform(pseq.species, 'compositional')
    pcoa.ordinate <- ordinate(pcoa.abundances, method="PCoA", distance="bray")
    saveRDS(pcoa.ordinate, file = "rds/pcoa.ordinate.rds")
} else {
    pcoa.ordinate <- readRDS("rds/pcoa.ordinate.rds")
}
```

```{r maaslin runs, results = 'hide'} 
 pseq.genus.core <- core(pseq.genus, detection = 0.001, prevalence = 0.01)
 pseq.genus.core.viruses.names <- taxa(pseq.genus.core) %>% mygrep(word = "virus$", complement = TRUE)
 pseq.genus.core.pruned <- prune_taxa(pseq.genus.core.viruses.names, pseq.genus.core)
 
if (!file.exists("rds/maaslin.rds")) {
     maaslin <- maaslinwrapper(pseq = pseq.genus.core.pruned,
                                    looped = var.BP,
                                    forced = var.CL,
                              taxa = taxa(pseq.genus.core.pruned))

    saveRDS(maaslin, file = "rds/maaslin.rds")
} else {
    maaslin <- readRDS(file = "rds/maaslin.rds")
}
```


## Characteristics of the study sample. (Table 1.)

```{r Characteristics}
tbl1 <- tableone(meta(pseq.species))
```

```{r Write characteristics, include=FALSE}
tbl1head <- "Characteristics of the study sample."
tbl1foot <- "Continuous variables are presented as mean (standard deviation). Categorical variables reported as absolute and relative frequencies. BP indicates blood pressure, BMI, body mass index, RAS, renin-angiotensin system."
writetable(doc, tbl1, number = 1, tbl1head, tbl1foot)
```

## Alpha & Beta plot (Figure 1.)

```{r alphabeta definitions}
dset.alpha <- meta.merge.alphadiversity(pseq.species) %>%
    mutate(diversity_shannon = scale(diversity_shannon),
           MAP = oMAP,
           PULSEPRESSURE = oPULSEPRESSURE,
           SYSTM = oSYSTM,
           DIASM = oDIASM)

alphadiversity <- list(
    min = calculateglm(dset.alpha,
                       modelstring = sprintf("%%s ~ %s + diversity_shannon",
                                             paste0(var.CL.min, collapse = " + ")),
                       filterstr = "shannon"),
    max = calculateglm(dset.alpha,
                       modelstring = sprintf("%%s ~ %s + diversity_shannon",
                                             paste0(var.CL, collapse = " + ")),
                       filterstr = "shannon"))

diversities <- mergediversities(alphadiversity, adonis.species, names.dset = names.dset)
```

Minimum coefficient for alpha diversity is `r rbind(diversities$min,
diversities$max) %>% pull(estimate) %>% min`.

Results in minimum model of alpha diversity

```{r talbe alpha div min}
alphadiversity$min %>%
    select(response, estimate, p.value, conf.low, conf.high) %>%
    mutate(mean_ci = sprintf("p=%s; 95%%-CI %.2f-%.2f",
                              pub.p(p.value), conf.low, conf.high)) %>%
    mutate_if(is.numeric, round, 3) %>%
    arrange(p.value) %>%
    kable
```

Results for full model of alpha diversity

```{r talbe alpha div max}
alphadiversity$max %>%
    select(response, estimate, p.value, conf.low, conf.high) %>%
    mutate(mean_ci = sprintf("p=%s; 95%%-CI %.2f-%.2f",
                              pub.p(p.value), conf.low, conf.high)) %>%
    mutate_if(is.numeric, round, 3) %>%
    arrange(p.value) %>%
    kable
```

Difference of R2 between full and minimal models

```{r difference in beta diversity}
merge(diversities$min %>%
      select(response, R2, R2.p) %>%
      dplyr::rename(R2.min = R2, p.min = R2.p),
      diversities$max %>%
      select(response, R2, R2.p) %>%
      dplyr::rename(R2.full = R2, p.full = R2.p),
      by = "response") %>%
    mutate(R2.diff = R2.full - R2.min) %>%
    kable
```


```{r save grob}
alpha.diversity.min <- plot.alpha(diversities$min, alphabreaks = seq(-1,0,0.2))
alpha.diversity.max <- plot.alpha(diversities$max, alphabreaks = seq(-1,0,0.2))

beta.diversity.min <- plot.beta(diversities$min)
beta.diversity.max <- plot.beta(diversities$max)

gs4 <- list(alpha.diversity.min$yaxis,
            alpha.diversity.min$plot,
            beta.diversity.min$plot,
            alpha.diversity.min$legend,
            alpha.diversity.min$xaxis,
            beta.diversity.min$xaxis,
            beta.diversity.min$xlab,
            text_grob("A.", size = 18),
            alpha.diversity.max$yaxis,
            alpha.diversity.max$plot,
            beta.diversity.max$plot,  
            alpha.diversity.max$xaxis,
            beta.diversity.max$xaxis,
            beta.diversity.max$xlab,
            text_grob("B.", size = 18))
 
g4 <- arrangeGrob(grobs = gs4,
                   layout_matrix = rbind(
                      c(8,    NA,    NA, NA,   NA, NA, NA),
                      c(NA, 1,    2,    NA, 3, NA, NA),
                      c(NA, 1,    2,    NA, 3, NA, 4),
                      c(NA, NA, 5,    NA,6, NA, NA),
                      c(NA, NA, NA, NA,7, NA, NA),
                      c(15,    NA,    NA, NA,   NA, NA, NA),
                      c(NA, 9,    10,  NA,  11, NA, NA),
                      c(NA, 9,    10,  NA,  11, NA, NA),
                      c(NA, NA, 12,   NA, 13, NA, NA),
                      c(NA, NA, NA, NA,14, NA, NA)),
                  widths=c(0.7, 4, 0.7, 0.1, 5, 0.7, 3),
                  heights=rep(c(1, 1, 6, 1, 2), 2))

ggsave(file = "cache/alpha-beta.png", plot=g4, height=6, width=9)
```

```{r Write figure 1, include=FALSE}
fig1head <- "Associations between BP variables and microbial diversity."
fig1foot <- "Results in panel A are calculated using minimal model using only age and sex for covariates. Panel B has the full model where covariates are age, sex, BMI, smoker, exercise, and four antihypertensive medications. The blue tinted box on the left represents four linear and one logistic model where blood pressure variables are dependent variables and Shannon's index is included in covariates. The gray tinted bars represent beta diversity i.e. analysis of variance for Bray-Curtis distance matrix where blood pressure variables are included in covariates. Result marked with asterisk are significant at FDR 0.05. Permutational analysis for beta diversity has 1000 permutations (p=0.01)."
writeimage(doc, 1, "cache/alpha-beta.png", fig1head, fig1foot)
```

## Principal coordinate analysis (Figure 2.)

```{r pcoa plot}
pcoa.vectors <- pcoa.ordinate$vectors %>% as.data.frame
eig.fracs <- pcoa.ordinate$values$Relative_eig

pcoa.df <- merge(pcoa.vectors %>%
                 select(Axis.1, Axis.2, Axis.3),
                 meta(pseq.species), by=0, all = TRUE) %>%
    mutate(STATETREATMENT = factor(paste0(HYPERTENSION, ANYDRUG),
                                   levels = c("11", "10", "01", "00")),
           gMAP = cut(oMAP, seq(60, 160, 15))) %>%
    mutate_at(vars(starts_with("Axis.")), .funs = funs(myscale(.)))

axis_labeller <- function(variable, value){
    axis.labels <- list("Axis.2" = sprintf("PCoA Axis 2 (%.1f%%)", 100*eig.fracs[2]),
                        "Axis.3" = sprintf("PCoA Axis 3 (%.1f%%)", 100*eig.fracs[3]))
    return(axis.labels[value])
}

plot_labeller <-  function(value) {
        plot.labels <- list("Axis.2" = sprintf("A."),
                            "Axis.3" = sprintf("B."))
        return(plot.labels[value])
}

pcoa.plot <- ggplot(data=pcoa.df %>% gather(key, Axis, Axis.2, Axis.3),
                    aes(x=Axis.1, y=Axis, color = HYPERTENSION)) +
    facet_wrap(~key, scales = "free_y", strip.position = "left", labeller = axis_labeller) +
    geom_point(size=0.1, alpha=0.4) +
    xlab(sprintf("PCoA Axis 1 (%.1f%%)", 100*eig.fracs[1])) +
    ylab(NULL) +
    scale_colour_manual(name = "State and treatment",
                        labels = c("Normotensive", "Hypertensive"),
                        breaks=c(0, 1),
                        values = c("blue", "red")) +   
    scale_x_continuous(breaks=seq(-5, 5, 1)) +
    scale_y_continuous(breaks=seq(-5, 5, 1)) +
    theme_classic() +
    guides(colour = guide_legend(override.aes = list(size=4))) +
    coord_cartesian(clip = 'off') +
    geom_text(aes(x = -Inf, y = Inf, label = plot_labeller(key)),
              size = 5,
              hjust = 2,
              vjust = -1,
              inherit.aes = FALSE) +
    theme(text = element_text(size=12),
          legend.position = "none",
          strip.background = element_blank(),
          strip.placement = "outside",
          aspect.ratio = 1,
          strip.text = element_text(size = 14),
          axis.title.x = element_text(size = 14))

ggsave(file = "cache/pcoa-species.png", plot=pcoa.plot, height=3.4, width=6, units = "in", dpi = 300)
```

First three axis explain portion (`r eig.fracs[1:3]`) of
variation. Testing associations to blood pressure variables on PCoA
axis 1

```{r top generas, eval = FALSE, include = FALSE}
abund.genus <- abundances(pseq.genus, transform = "compositional") %>%
    t %>%
    as.data.frame %>%
    tibble::rownames_to_column("id") %>%
    setNames(tolower(replace.brackets(names(.))))


abund.genus.bacteria <- abund.genus %>% select(-contains("virus")) %>% colnames

abund.df <- merge(pcoa.vectors %>%
                  select("Axis.1", "Axis.2", "Axis.3") %>%
                  tibble::rownames_to_column("id"),
                  abund.genus %>% select(id, abund.genus.bacteria),
                  by = "id") %>%
    merge(.,  meta(pseq.genus) %>% tibble::rownames_to_column("id"), by = "id")

pcoacorabund <- function(df,
                         genera.names,
                         axis.names = c("Axis.1", "Axis.2", "Axis.3")) {
    lapply(c2l(genera.names), function (taxa) 
        lapply(c2l(axis.names), function(axis) {
            fo <- sprintf("%s ~ %s", axis, taxa)
            model <- lm(as.formula(fo), data = df)
            summary(model)$r.squared
        }))
}

pcoacor.genus <- pcoacorabund(abund.df, genera.names = abund.genus.bacteria)
pcoacor.genus.df <- map_df(pcoacor.genus, ~as.data.frame(.x), .id="id")

pcoacor.genus.df %>%
    arrange(-Axis.3) %>%
    head(20) %>% kable
```

Significant associations between BP-variables and first three PCoA axis

```{r pcoa axis analysis axis 1}
glm.pcoa <- lapply(c2l("Axis.1", "Axis.2", "Axis.3"), function(axis)
    calculateglm(pcoa.df,
                 modelstring = sprintf("%%s ~ %s + %s", axis, paste(var.CL, collapse = "+")),
                 responses = list(model_1 = "oMAP", model_2 = "oSYSTM", model_3 = "oDIASM",
                                          model_4 = "oPULSEPRESSURE", model_5 = "HYPERTENSION"),
                 filterstr = "Axis"))

do.call(rbind, glm.pcoa) %>% 
    select(response, term, estimate, std.error, p.value, conf.low, conf.high) %>%
    mutate_if(is.numeric, round, 3) %>%
    filter(p.value < 0.05) %>%
    arrange(p.value) %>%
    kable

```

```{r Write figure 2, include=FALSE}
fig2head <- "Principal coordinate analysis for bacterial abundances."
fig2foot <- sprintf("Principal coordinate analysis for bacterial abundances at species level. Bray-Curtis distances are calculated for abundances after compositional transformation. First two axes explain %.1f%% of the variation.", round(100*sum(eig.fracs[c(1,3)]),1))
writeimage(doc, 2, "cache/pcoa-species.png", fig2head, fig2foot)
```

## Direct associations between genus level and blood pressure variables (figure 3)

For magnitude, age, sex, and BMI explain `r round(summary(lm(MAP ~ BL_AGE +
SEX + BMI, data = meta(pseq.genus)))$adj.r.squared * 100, 1)`% of MAP.

```{r maaslin clean results}
maas.results.df.signf <- maaslin %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
                  Feature = gsub("[gs]_", "", Feature),
                  beta = Coefficient) %>%
    dplyr::filter(Qval < 0.05) %>%
    arrange(Feature)
```

```{r maaslin plot}
my.plot.order <- function(x) {
    y <- seq(length(x))
    y[x == "Systolic BP"] = 4
    y[x == "Diastolic BP"] = 3
    y[x == "Pulse pressure"] = 2
    y[x == "Mean arterial pressure"] = 1
    y[x == "Hypertension"] = 0
    y
}

maas.all.pairs <- expand.grid(Feature = maas.results.df.signf %>% pull(Feature),
                         Name = maas.results.df.signf %>% pull(Name))

maas.tables.df <- merge(maas.results.df.signf,
                        maas.all.pairs,
                        all.y=TRUE,
                        by.y=c('Feature', 'Name'),
                        by.x=c('Feature', 'Name')) %>%
    mutate(p.groups = cut(P.value*ifelse(Coefficient < 0, -1, 1),
                          breaks = c(-0.05, -0.01, -0.001, 0, 0.001, 0.01, 0.05),
                          labels = c("beta < 0, p < 0.05",
                                     "beta < 0, p < 0.01",
                                     "beta < 0, p < 0.001",
                                     "beta > 0, p < 0.001",
                                     "beta > 0, p < 0.01",
                                     "beta > 0, p < 0.05")))

mycolors <- c("beta < 0, p < 0.05" = "#B2182B",
              "beta < 0, p < 0.01" = "#EF8A62",
              "beta < 0, p < 0.001" = "#FDDBC7",
              "beta > 0, p < 0.001" = "#D1E5F0",
              "beta > 0, p < 0.01" = "#67A9CF",
              "beta > 0, p < 0.05" = "#2166AC",
              "NA" = "gray50")


maaslinplot <- ggplot(maas.tables.df, aes(x = Feature, y = reorder(Name, my.plot.order(Name)), fill = beta)) +
    geom_tile(aes(fill = 1)) +
    geom_tile(colour="white", size=0.25) +
    scale_fill_distiller(palette = "RdBu", name = "Effect size",
                         limits=c(-0.003, 0.003), breaks = c(-0.003, 0, 0.003), na.value="grey30") +
    coord_fixed() +
    xlab("") +
    ylab("") +
    theme_classic(10) +  
    theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust=0.5, size=10),
          axis.text.y = element_text(size=10))

ggsave(file = "cache/maaslin.png", plot = maaslinplot, height = 30, width = 40, unit = "in", dpi = 300)
```

Max value of abs beta is `r maas.results.df.signf %>% pull(Coefficient) %>% abs %>% max`.

```{r maaslin table}
maas.results.df.signf %>%
    select(Feature, Value, Coefficient, Qval) %>%
    arrange(Qval) %>%
    kable
```

```{r multi model, eval = FALSE, include = FALSE}
abund.genus.systm <- pseq.genus %>%
    abundances(., transform = "compositional") %>%
    t %>%
    as.data.frame %>%
    tibble::rownames_to_column("id")

df.genus.systm <- meta(pseq.genus) %>%
    tibble::rownames_to_column("id") %>%
    full_join(., abund.genus.systm, by = "id") %>%
    mutate(Anaerotruncus = scale(asin(sqrt(g_Anaerotruncus))),
           Sutterella = scale(asin(sqrt(g_Sutterella))))

fo.genus.systm <- sprintf("oSYSTM ~ Anaerotruncus + Sutterella + Anaerotruncus:Sutterella + %s",
                          paste0(var.CL, collapse = " + "))

lm(as.formula(fo.genus.systm), data = df.genus.systm) %>% summary

df.genus.systm %>%
    mutate(diff = -0.75418 * Anaerotruncus + 0.89265 * Sutterella) %>%
    pull(diff) %>%
    summary
```

```{r scatter plots, eval = FALSE, include = FALSE}
scatter.signf.bacteria <- maas.results.df.signf %>% pull(Feature) %>% unique

scatter.meta <- meta(pseq.genus) %>%
    tibble::rownames_to_column("id") %>%
      mutate(MAP = oMAP,
           PULSEPRESSURE = oPULSEPRESSURE,
           SYSTM = oSYSTM,
           DIASM = oDIASM)

scatter.abund <- abundances(pseq.genus, transform = "clr") %>%
    t %>%
    as.data.frame %>%
    tibble::rownames_to_column("id") %>%
    select(id, scatter.signf.bacteria) %>%
    mutate_at(.vars = vars(scatter.signf.bacteria), .funs = funs(myscale(.)))

scatter.full <- full_join(scatter.meta, scatter.abund, by = "id")

scatter.combinations <- expand.grid(cc("SYSTM", "DIASM", "PULSEPRESSURE", "MAP"),
                                    c2l(scatter.signf.bacteria)) %>%
    setNames(c("rr", "abund"))

scatter.plot <- function(df,
                         maas.results,
                         rr,
                         abund,
                         covariates = c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB",
                                        "BL_USE_RX_C03", "BL_USE_RX_C07", "BL_USE_RX_C08",
                                        "BL_USE_RX_C09"),
                         prediction = TRUE,
                         plots = TRUE) {
    fo <- sprintf("%s ~ %s + %s", rr, abund, paste0(covariates, collapse="+"))
    model <- lm(as.formula(fo), data = df)

    if (prediction == FALSE) return(model %>% summary)
    
    df.predict <- data.frame(BPV = seq(-5,5,0.1)) %>%
        mutate(SEX = as.factor(0),
               BL_AGE = df %>% pull(BL_AGE) %>% mean,
               BMI = df %>% pull(BMI) %>% mean,
               CURR_SMOKE = as.factor(0),
               Q57X = as.factor(1),
               DIAB = as.factor(0),
               BL_USE_RX_C03 = as.factor(0),
               BL_USE_RX_C07 = as.factor(0),
               BL_USE_RX_C08 = as.factor(0),
               BL_USE_RX_C09 = as.factor(0),
               !!abund := seq(-5,5,0.1)
               )
    prediction <- cbind(df.predict, predict(model, df.predict, interval = 'confidence'))

    if (plots == FALSE) return(prediction)

    feature <- replace.brackets(abund)

    qval.maaslin <- maas.results %>%
        dplyr::filter(Feature == feature, Value == rr) %>%
        nrow

    if (qval.maaslin == 0) { return (ggplot() + ggplot2::theme_minimal()) }
    pval <- pub.p(summary(model)$coef[2,4])
    rsqr <- signif(summary(model)$adj.r.squared, 2)
    slope <- signif(model$coef[[2]], 2)

    ggplot(prediction, aes_string(x = abund, y = "fit")) +
        geom_line() +
        geom_point(size=0.1, shape=1, aes_string(x = abund, y = rr, color = "SEX"),
                   data = df) +
        labs(title = sprintf("Adj R2 = %s, Slope = %s, p = %s", rsqr, slope, pval)) +
        xlab(feature) +
        ylab(rr) +
        ylim(0,200) +
        ggplot2::theme_minimal() +
        theme(plot.title = element_text(size=8)) +
        theme(legend.position="none")
}

scatterplots <- lapply(data.frame(t(scatter.combinations)),
                       function(x)
                           scatter.plot(scatter.full, maas.results.df.signf, x$rr, x$abund))

scatterplot <- do.call("grid.arrange", c(scatterplots, ncol=4))
ggsave(file = "cache/scatter.png", plot = scatterplot, height = 10, width = 10, dpi = 300)
```

```{r maaslin means}
pseq.genus.core.pruned.table <- pseq.genus.core.pruned %>%
    prune_taxa(c("g_Adlercreutzia", "g_Anaerotruncus", "g_Sutterella"), .) %>%
    transform(transform = "compositional") %>%
    psmelt %>%
    mutate(map_groups = relevel(factor(dplyr::ntile(MAP, 3)), ref='1'),
           systm_groups = relevel(factor(dplyr::ntile(SYSTM, 3)), ref='1'),
           Abundance = myscale(Abundance))

table_bp_abund <- function(pseq, group) {
    pseq %>%
        group_by(.dots = c(group, "OTU")) %>%
        summarize(mean = mean(Abundance), sd = sd(Abundance)) %>%
        mutate(beta_sd = sprintf("%.2f ± %.2f", mean, sd)) %>%
        select(OTU, beta_sd) %>%
        spread(OTU, beta_sd) %>%
        ungroup %>%
        dplyr::rename("grp" = group) %>%
        mutate("grp" = paste0(group, "_", grp))
}

rbind(table_bp_abund(pseq.genus.core.pruned.table, "map_groups"),
             table_bp_abund(pseq.genus.core.pruned.table, "systm_groups")) %>%
    tibble::column_to_rownames("grp") %>%
    t %>%
    as.data.frame %>%
    kable

```

```{r Write figure 3, include=FALSE}
fig3head <- "Associations between genus level abundances and blood pressure variables."
fig3foot <- "Only bacteria with significant associations are shown. Blood pressure variables are normalized and abundances are arcsin-square root transformed. Dark gray color represents insignificant associations."
writeimage(doc, 3, "cache/maaslin.png", fig3head, fig3foot)
```

## Lactobacillus (figure 4)

The fourth and final step is to study how the amount of dietary salt
affect the lactobacillus abundances and how these abundances affect
the odds for hypertension. We load genus data with dU-NA and combine
it in a data frame with CLR transformed lactobacillus abundances.

```{r lacto data frame}
df.genus.salt <- pseq.genus %>%
    microbiome::transform(transform = "clr") %>%
    prune_taxa(c("g_Lactobacillus"), .) %>%
    psmelt %>%
    dplyr::filter(!is.na(NA.)) %>%
    spread(OTU, Abundance) %>%
    dplyr::mutate(dUNA = myscale(NA.),
                  salt_groups = relevel(factor(dplyr::ntile(dUNA, 3)), ref='1'),
                  lacto_groups = relevel(factor(dplyr::ntile(g_Lactobacillus, 3)), ref='1'))
```

Lactobacillus prevalence

```{r lactobacillus prevalence}
pseq.genus %>%
    microbiome::transform(transform = "compositional") %>%
    prune_taxa(c("g_Lactobacillus"), .) %>%
    psmelt %>%
    spread(OTU, Abundance) %>%
    dplyr::mutate(lacto.prevalent = ifelse(g_Lactobacillus > 0.001, TRUE, FALSE),
                  duna.present = ifelse(is.na(NA.), 0, 1)) %>%
    group_by(duna.present) %>%
    summarize(lacto_detected = sum(lacto.prevalent), n = n(), ratio = lacto_detected/n)
``` 


Characteristics in salt analysis. Analyses are limited by the number
of participants with collected dU-NA.

```{r salt characteristics}
pseq.genus.salt %>%
    meta %>%
    gather(key,value) %>%
    group_by(key) %>%
    summarise_all(funs(N = n(),
                       Mean = mean(as.numeric(value), na.rm = TRUE),
                       sd = sd(as.numeric(value), na.rm = TRUE),
                       NAs = sum(is.na(value))))  %>%
    mutate_if(is.numeric, round, 3) %>%
    kable()
```

### How sodium affects lactobacillus abundances?

Associations between continuous dU-NA and lactobacillus abundances.

```{r abund salt lm continuous}
lm.lacto.duna <- lm(g_Lactobacillus ~ dUNA + BL_AGE + SEX, data = df.genus.salt)
lm.lacto.duna %>% tidy %>% mutate_if(is.numeric, round, 3) %>% kable
```

Testing assumptions for linear regression analysis

```{r abund salt lm continuous checks table}
gvlma.table.plot(lm.lacto.duna)$table %>% kable
```

Diagnostic plots for linear model

```{r abund salt lm continuous checks plot, fig.width=12, fig.height=14}
gvlma.table.plot(lm.lacto.duna)$plot %>% plot
```

### Is there associations between salt groups and abudances?

Associations between categorical dU-NA split in three equal size groups and lactobacillus abundances

```{r abund salt lm group}
lm.lacto.saltgroup <- lm(g_Lactobacillus ~ salt_groups + BL_AGE + SEX, data = df.genus.salt)
lm.lacto.saltgroup %>% tidy %>% mutate_if(is.numeric, round, 3) %>% kable
```

Testing assumptions for linear regression analysis

```{r abund salt lm group checks table}
gvlma.table.plot(lm.lacto.saltgroup)$table %>% kable
```

Diagnostic plots for linear model

```{r abund salt lm group checks plot, fig.width=12, fig.height=14}
gvlma.table.plot(lm.lacto.saltgroup)$plot %>% plot
```

Analysing also differences between salt groups using ANOVA.

```{r salt anova}
aov.lacto.saltgroup <- aov(g_Lactobacillus ~ salt_groups + BL_AGE + SEX, data = df.genus.salt)
aov.lacto.saltgroup %>% xtable %>% kable
```

Levene's test for equality of variance

```{r salt levene}
car::leveneTest(g_Lactobacillus ~ salt_groups, data = df.genus.salt) %>% kable
```

Tukey's range for pairwise test between salt groups

```{r salt HSD}
hsd.lacto.saltgroup <- TukeyHSD(aov.lacto.saltgroup, "salt_groups")
hsd.lacto.saltgroup$salt_groups %>% kable
```

### Adjusting means for forest plot

Calculate adjusted means for lactobacillus assuming male sex and mean age.

```{r lacto adjusted means}
df.genus.salt.unadjusted <- with(df.genus.salt, data.frame(salt_groups = as.factor(seq(3)),
                                                           SEX = as.factor(0),
                                                           BL_AGE = mean(BL_AGE)))
                               
adjmean.lacto.saltgroup <- predict(lm.lacto.saltgroup,
                               df.genus.salt.unadjusted,
                               interval = "confidence") %>%
    as.data.frame %>%
    dplyr::rename(estimate = fit,
                  conf.low = lwr,
                  conf.high = upr) %>%
    tibble::rownames_to_column("term")
```


## Is there associations between lactobacillus abudance and hypertension?

Studying associations between blood pressure variables and lactobacillus abundances

```{r lactobacillus RR}
calculateglm(df.genus.salt,
             modelstring = "%s ~ g_Lactobacillus + BL_AGE + SEX",
             filterstr = "Lactobacillus") %>% 
    select(response, term, estimate, std.error, p.value) %>%
    mutate_if(is.numeric, round, 3) %>%
    kable
```

Checking assumptions for linear regression for MAP

```{r table map lactobacillus}
gvlma.table.plot(lm(MAP ~ g_Lactobacillus + BL_AGE + SEX, data = df.genus.salt))$table %>% kable
```

Diagnostic plots for linear model

```{r plot map lactobacillus, fig.width=12, fig.height=14}
gvlma.table.plot(lm(MAP ~ g_Lactobacillus + BL_AGE + SEX, data = df.genus.salt))$plot %>% plot
```

Odds for hypertension by categorical lactobacillus abundance.

```{r glm htn lacto groups}
glm.hypertension.lactogroup <- glm(HYPERTENSION ~ lacto_groups + BL_AGE + SEX,
                  family = binomial(link=logit),
                  data = df.genus.salt)

odds.hypertension.lactogroup <- glm.hypertension.lactogroup %>%
    broom::tidy(conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE) %>%
    filter(!grepl("Intercept", term)) %>%
    select(term, estimate, conf.low, conf.high) %>%
    add_row(term = "lacto_groups1", estimate = 1.0, conf.low = NA, conf.high = NA) %>%
    dplyr::filter(grepl("lacto", term))

glm.hypertension.lactogroup %>%
    broom::tidy(conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE) %>%
    mutate_if(is.numeric, round, 3) %>%
    kable
```

Odds for hypertension

```{r odds htn lacto}
odds.hypertension.lactogroup <- glm.hypertension.lactogroup %>%
    broom::tidy(conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE) %>%
    filter(!grepl("Intercept", term)) %>%
    select(term, estimate, p.value, conf.low, conf.high) %>%
    add_row(term = "lacto_groups1", estimate = 1.0, conf.low = NA, conf.high = NA) %>%
    dplyr::filter(grepl("lacto", term))
odds.hypertension.lactogroup %>% kable
```

Power analysis of odds of hypertension

```{r power hypertention}
power.htn <- pwr.f2.test(u = 3, v=NULL, f2 = 0.02, sig.level=0.05, power=0.8)
round(power.htn$v + power.htn$u + 1)

pwr.f2.test(u = 3, v=836, f2 = NULL, sig.level=0.05, power=0.95)
```

## Twin-forest plot

```{r forest lims, eval = FALSE, include = FALSE}
adjmean.lacto.saltgroup
```

```{r forest plot lacto}
odds.hypertension.lactogroup
gsalt <- grid.arrange(
    myforestplot(adjmean.lacto.saltgroup,
                 xlab = "Dietary salt",
                 ylab = "Lactobacillus abundance",
                 subtitle = "A.",
                 my_y_scale = scale_y_continuous(limits = c(1.15,1.42), breaks = seq(0, 5, 0.1))),
    myforestplot(odds.hypertension.lactogroup,
                 xlab = "Lactobacillus abundance",
                 ylab = "Odds of hypertension",
                 subtitle = "B.",
                 my_y_scale = scale_y_log10(limits = c(0.4, 1.5), breaks = seq(0.5, 2.0, 0.5)),
                 interceptone = TRUE),
    ncol=2)

ggsave(file = "cache/salt-forest.png", plot=gsalt, height=4, width=6, dpi = 300)
```

```{r Write figure 4, include=FALSE}
fig4head <- "Associations between dietary salt, lactobacillus abundance, and odds for hypertension."
fig4foot <- "In panel A we see lactobacillus abundances in different dietary salt groups. The mean value is adjusted using age and sex. In panel B we split participants in four groups by lactobacillus abundances and calculate odds ratio for hypertension. Age and sex are included in logistic model. A 95 % CI is drawn in both panels."
writeimage(doc, 4, "cache/salt-forest.png", fig4head, fig4foot)
```

```{r squared clinical, eval = FALSE, include = FALSE}
mylmrsqr <- function(df, response, loopcovariates) {
    model.list <- list()
    for (i in seq(length(loopcovariates))) {
        fo <- sprintf("%s ~ %s", response, paste(loopcovariates, collapse = " + "))
        message(sprintf("formula : %s", fo))
        model <- lm(as.formula(fo), data = df)
        model$call <- as.formula(fo)
        model.list[[i]] <- model
        loopcovariates <- loopcovariates[-length(loopcovariates)]
    }
    return(model.list)
}

af.models <- mylmrsqr(df = meta(pseq.species),
         response = "MAP",
         loopcovariates = c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB",
                            "ANYDRUG"))

af <- do.call(anova, af.models)

af %>%
    as.data.frame %>%
        mutate(Rsqr =  `Sum of Sq`/sum(`Sum of Sq`, na.rm = T)*100)


c(summary(lm(SYSTM ~ BL_AGE + SEX, meta(pseq.species)))$adj.r.squared,
summary(lm(DIASM ~ BL_AGE + SEX, meta(pseq.species)))$adj.r.squared,
summary(lm(PULSEPRESSURE ~ BL_AGE + SEX, meta(pseq.species)))$adj.r.squared,
summary(lm(MAP ~ BL_AGE + SEX, meta(pseq.species)))$adj.r.squared) %>% mean

c(summary(lm(SYSTM ~ BL_AGE + SEX + BMI, meta(pseq.species)))$adj.r.squared,
summary(lm(DIASM ~ BL_AGE + SEX + BMI, meta(pseq.species)))$adj.r.squared,
summary(lm(PULSEPRESSURE ~ BL_AGE + SEX + BMI, meta(pseq.species)))$adj.r.squared,
summary(lm(MAP ~ BL_AGE + SEX + BMI, meta(pseq.species)))$adj.r.squared) %>% sort

```


```{r Write docx to file, include=FALSE}
print(doc, target = paste0("report/articletwo-", now, ".docx"))
```

```{r save session}
save.image(file = paste0("session/session-", now, ".Rdata"))
```
