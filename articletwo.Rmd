---
title: "Hypertension and microbiome"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis', cache=FALSE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

dir.create("rds/", showWarnings = FALSE)
dir.create("session/", showWarnings = FALSE)
```

# Command line arguments

Calculations ran at

```{r Command line arguments}
now <- format(Sys.time(), '%Y%m%d-%H%M%S')

if (exists("args")) {
    if ("time" %in% names(args)) now <- args$time
    
    if("clean" %in% names(args)) {
        unlink("rds", recursive=TRUE)
        unlink("cache", recursive=TRUE)
    }
    if ("tags" %in% names(args)) 
        rtags('~/phd/research/articletwo/', recursive = FALSE, pattern = '\\.[RrSs](rw|md)?$',
              ofile = '~/phd/research/articletwo/TAGS', verbose = TRUE, append = FALSE)
    if ("loadlast" %in% names(args) )
        load(paste0("session/", sort(list.files("session"), decreasing = TRUE)[1]))
}
```


# Importing libraries:

```{r libraries, cache = FALSE}
library(dplyr)
library(tibble)
library(phyloseq)
library(nortest)
library(microbiome)
library(finriskmetagcommon)
library(knitr)
library(tidyr)
library(vegan)
library(reshape)
library(ggpmisc)
library(Maaslin)
library(parallel)
library(officer)
library(flextable)
library(rvg)
library(tableone)
library(scales)
library(ggplot2)
library(gridExtra)
library(png)
library(pander)
library(ggpubr)
library(broom)
library(ggfortify)
library(RColorBrewer)
```

Session info
 
```{r Session info}
pander(sessionInfo(), compact = TRUE)
```

```{r Initialize docx, include = FALSE, cache = FALSE}
doc <- read_docx(path = "style/articlestyle.docx") %>%
  body_remove()
dir.create("rds", showWarnings = FALSE)
dir.create("cache", showWarnings = FALSE)
```

# Sources

### Officer functions

<details>
  <summary>Open/Close</summary>

```{r Officer importer, code=readLines("articletwo-officer.R")}
source("articletwo-officer.R")
```

</details>

### RR biome functions

<details>
  <summary>Open/Close</summary>
  
```{r RR biome functions, code=readLines("articletwo-rrbiome.R")}
source("articletwo-rrbiome.R")
```

</details>

### EdgeR plot functions

<details>
  <summary>Open/Close</summary>

```{r EdgeR functions, code=readLines("aaro/edgeR_plot_functions.R")}
source("aaro/edgeR_plot_functions.R")
```

</details>

### Plot functions

<details>
  <summary>Open/Close</summary>

```{r Plot functions, code=readLines("articletwo-ggplot.R")}
source("articletwo-ggplot.R")
```

</details>


# Loading data
	
Loading descriptions for clinical data

```{r variables, warning = FALSE}
names.dset <- getdescriptions()
```

Loading phyloseq object

```{r data}
pseq.genus <- readRDS("data/phfinrisk_genus_all_drop50k_2018-11-16.RDs")
pseq.species <- readRDS("data/phfinrisk_species_all_drop50k_2018-12-21.RDs")
```

Updating phyloseq objects

```{r updating phyloseq objects}
phyloseq::sample_data(pseq.genus) <- phyloseq::sample_data(filter.phenotype.data(pseq.genus))
phyloseq::sample_data(pseq.species) <- phyloseq::sample_data(filter.phenotype.data(pseq.species))
```

Sample data has dimensions (`r dim(sample_data(pseq.species))`).

## Models

```{r matrix calculation}
if (!file.exists("rds/bray.dist.m.species.rds")) {
    bray.dist.m.species <- calculate.beta.matrix(pseq.species)
    saveRDS(bray.dist.m.species, file = "rds/bray.dist.m.species.rds")
} else {
    bray.dist.m.species  <- readRDS("rds/bray.dist.m.species.rds")
}
```

 ```{r adonis calculation}
 if (!file.exists("rds/adonis.species.rds")) {
     adonis.species = list()
     adonis.species$min <- calculateadonis(dset = meta(pseq.species),
                                           matrix = bray.dist.m.species,
                                           covariates = c("BL_AGE", "SEX"),
                                           npermutations = 1000)
     adonis.species$max <- calculateadonis(dset = meta(pseq.species),
                                           matrix = bray.dist.m.species,
                                           covariates = c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB",
                                                          "BL_USE_RX_C03", "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09"),
                                           npermutations = 1000)
     saveRDS(adonis.species, file = "rds/adonis.species.rds")
    } else {
     adonis.species  <- readRDS("rds/adonis.species.rds")
}
```

```{r pcoa calculate}
if (!file.exists("rds/pcoa.ordinate.rds")) {
    pcoa.abundances <- microbiome::transform(pseq.species, 'compositional')
    pcoa.ordinate <- ordinate(pcoa.abundances, method="PCoA", distance="bray")
    saveRDS(pca.prcomp, file = "rds/pcoa.ordinate.rds")
} else {
    pcoa.ordinate <- readRDS("rds/pcoa.ordinate.rds")
}
```

```{r core taxa}
pseq.genus.core <- core(pseq.genus, detection = 0.001, prevalence = 0.01)
```

```{r maaslin runs, results = 'hide'} 
maaslin <- list()

genus.core.bacteria <- pseq.genus.core %>%
    abundances %>%
    rownames %>%
    replace.brackets %>%
    mygrep(".Bacteria$", .)


maaslin$genus <- maaslinwrapper(pseq = pseq.genus.core,
                looped = c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION"),
                forced = c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB", "BL_USE_RX_C03",
                           "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09"),
                taxa = paste0(genus.core.bacteria, collapse = ","))
```


## Characteristics of the study sample. (Table 1.)

```{r Characteristics}
tbl1 <- tableone(meta(pseq.species))
```

```{r Write characteristics}
tbl1head <- "Characteristics of the study sample."
tbl1foot <- "Continuous variables are presented as mean (standard deviation). Categorical variables reported as absolute and relative frequencies. BP indicates blood pressure, BMI, body mass index, RAS, renin-angiotensin system."
writetable(doc, tbl1, number = 1, tbl1head, tbl1foot)
```

## Alpha & Beta plot (Figure 1.)

```{r alphabeta definitions}
dset.alpha <- meta.merge.alphadiversity(pseq.species) %>%
    mutate(diversities_shannon = scale(diversities_shannon),
           MAP = oMAP,
           PULSEPRESSURE = oPULSEPRESSURE,
           SYSTM = oSYSTM,
           DIASM = oDIASM)

alphadiversity <- list(
    min = calculateglm(dset.alpha,
                       modelstring = "%s ~ BL_AGE + SEX  + diversities_shannon"),
    max = calculateglm(dset.alpha,
                       modelstring = "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09 + diversities_shannon"))

diversities <- mergediversities(alphadiversity, adonis.species)
```

Minimum coefficient for alpha diversity is `r rbind(diversities$min,
diversities$max) %>% pull(estimate) %>% min`.

```{r save grob}
alpha.diversity.min <- plot.alpha(diversities$min, colorlimit = 0.6)
alpha.diversity.max <- plot.alpha(diversities$max, colorlimit = 0.6)

beta.diversity.min <- plot.beta(diversities$min)
beta.diversity.max <- plot.beta(diversities$max)

gs4 <- list(alpha.diversity.min$yaxis,
            alpha.diversity.min$plot,
            beta.diversity.min$plot,
            alpha.diversity.min$legend,
            alpha.diversity.min$xaxis,
            beta.diversity.min$xaxis,
            beta.diversity.min$xlab,
            text_grob("A.", size = 18),
            alpha.diversity.max$yaxis,
            alpha.diversity.max$plot,
            beta.diversity.max$plot,  
            alpha.diversity.max$xaxis,
            beta.diversity.max$xaxis,
            beta.diversity.max$xlab,
            text_grob("B.", size = 18))
 
g4 <- arrangeGrob(grobs = gs4,
                   layout_matrix = rbind(
                      c(8,    NA,    NA, NA,   NA, NA, NA),
                      c(NA, 1,    2,    NA, 3, NA, NA),
                      c(NA, 1,    2,    NA, 3, NA, 4),
                      c(NA, NA, 5,    NA,6, NA, NA),
                      c(NA, NA, NA, NA,7, NA, NA),
                      c(15,    NA,    NA, NA,   NA, NA, NA),
                      c(NA, 9,    10,  NA,  11, NA, NA),
                      c(NA, 9,    10,  NA,  11, NA, NA),
                      c(NA, NA, 12,   NA, 13, NA, NA),
                      c(NA, NA, NA, NA,14, NA, NA)),
                  widths=c(0.7, 4, 0.7, 0.1, 5, 0.7, 3),
                  heights=rep(c(1, 1, 6, 1, 2), 2))

ggsave(file = "cache/alpha-beta.png", plot=g4, height=6, width=9)
```

```{r Write figure 1}
fig1head <- "Associations between BP variables and microbial diversity."
fig1foot <- "Results in panel A are calculated using minimal model using only age and sex for covariates. Panel B has the full model where covariates are age, sex, BMI, smoker, exercise, and four antihypertensive medications. The blue tinted box on the left represents four linear and one logistic model where blood pressure variables are dependent variables and Shannon's index is included in covariates. The gray tinted bars represent beta diversity i.e. analysis of variance for Bray-Curtis distance matrix where blood pressure variables are included in covariates. Result marked with asterisk are significant at FDR 0.05. Permutational analysis for beta diversity has 1000 permutations (p=0.01)."
writeimage(doc, 1, "cache/alpha-beta.png", fig1head, fig1foot)
```

## Principal coordinate analysis (Figure 2.)

```{r pcoa plot}
pcoa.vectors <- pcoa.ordinate$vectors %>% as.data.frame
eig.fracs <- pcoa.ordinate$values$Relative_eig
pcoa.df <- merge(pcoa.vectors %>% select(Axis.1, Axis.2),
                 meta(pseq.species), by=0, all = TRUE) %>%
    mutate(STATETREATMENT = factor(paste0(HYPERTENSION, ANYDRUG),
                                   levels = c("11", "10", "01", "00")))

pcoa.df %>% pull(STATETREATMENT) 

pcoa.plot <- ggplot(data=pcoa.df, aes(x=Axis.1, y=Axis.2, color = STATETREATMENT, shape = STATETREATMENT)) +
    geom_point(size=0.4, alpha=0.4) +
    xlab(paste("PCoA axis 1,", round(100*eig.fracs[1],1), "%")) +
    ylab(paste("PCoA axis 2,", round(100*eig.fracs[2],1), "%")) +
    scale_colour_manual(name = "State and treatment",
                        labels = c("Hypertensive, medication",
                                   "Hypertensive, no medication",
                                   "Normotensive, no medication"),
                        breaks=c("11", "10", "00"),
                        values = c("red", "red", "blue", "blue")) +   
    scale_shape_manual(name = "State and treatment",
                       labels = c("Hypertensive, medication",
                                  "Hypertensive, no medication",
                                  "Normotensive, no medication"),
                       breaks = c("11", "10", "00"),
                       values = c(4, 1, 1))+
    coord_fixed() +
    scale_x_continuous(breaks=seq(-100, 100, 20)) +
    scale_y_continuous(breaks=seq(-30, 30, 10)) +
    theme_classic() +
    guides(colour = guide_legend(override.aes = list(size=4))) +
    theme(text = element_text(size=14),
          legend.title = element_blank(),
          legend.text=element_text(size=10),
          legend.justification=c(1,0),
          legend.position=c(1,0),
          legend.margin=margin(t = 1, unit='mm'),
          legend.background = element_rect(fill=alpha('gray', 0.1)))

ggsave(file = "cache/pcoa-species.png", plot=pcoa.plot, height=5, width=5, dpi = 300)
```

```{r Write figure 2}
fig2head <- "Principal coordinate analysis for bacterial abundances."
fig2foot <- sprintf("Principal coordinate analysis for bacterial abundances at species level. Bray-Curtis distances are calculated for abundances after compositional transformation. First two axes explain %.1f%% of the variation.", round(100*sum(eig.fracs[1:2]),1))
writeimage(doc, 2, "cache/pca.png", fig2head, fig2foot)
```

## Direct associations between genus level and blood pressure variables (figure 3)

```{r maaslin}
maas.results.df.signf <- maaslin$genus %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
                  Feature = gsub("_Bacteria", "", Feature),
                  beta = Coefficient) %>%
    dplyr::filter(Qval < 0.05) %>%
    arrange(Feature)

my.plot.order <- function(x) {
    y <- seq(length(x))
    y[x == "Systolic BP"] = 4
    y[x == "Diastolic BP"] = 3
    y[x == "Pulse pressure"] = 2
    y[x == "Mean arterial pressure"] = 1
    y[x == "Hypertension"] = 0
    y
}

maas.all.pairs <- expand.grid(Feature = maas.results.df.signf %>% pull(Feature),
                         Name = maas.results.df.signf %>% pull(Name))
maas.tables.df <- merge(maas.results.df.signf,
                        maas.all.pairs,
                        all.y=TRUE,
                        by.y=c('Feature', 'Name'),
                        by.x=c('Feature', 'Name')) %>%
    mutate(p.groups = cut(P.value*ifelse(Coefficient < 0, -1, 1),
                          breaks = c(-0.05, -0.01, -0.001, 0, 0.001, 0.01, 0.05),
                          labels = c("beta < 0, p < 0.05",
                                     "beta < 0, p < 0.01",
                                     "beta < 0, p < 0.001",
                                     "beta > 0, p < 0.001",
                                     "beta > 0, p < 0.01",
                                     "beta > 0, p < 0.05")))

mycolors <- c("beta < 0, p < 0.05" = "#B2182B",
              "beta < 0, p < 0.01" = "#EF8A62",
              "beta < 0, p < 0.001" = "#FDDBC7",
              "beta > 0, p < 0.001" = "#D1E5F0",
              "beta > 0, p < 0.01" = "#67A9CF",
              "beta > 0, p < 0.05" = "#2166AC",
              "NA" = "gray50")

maaslinplot <- ggplot(maas.tables.df, aes(x = Feature,
                                          y = reorder(Name, my.plot.order(Name)),
                                          fill = p.groups)) +
    geom_tile(color = "white", aes(fill = "NA")) +
    geom_tile(color = "white") +
    scale_fill_manual(values = mycolors, name = "P-value", na.translate = F) +
    scale_x_discrete() +
    coord_fixed() +
    xlab("") +
    ylab("") +
    theme_classic(10) +  
    theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust=0.5, size=10),
          axis.text.y = element_text(size=10))
ggsave(file = "cache/maaslin.png", plot = maaslinplot, height = 3, width = 6, dpi = 300)
```

Max value of abs beta is `r maas.results.df.signf %>% pull(Coefficient) %>% abs %>% max`.

```{r scatter plots}
scatter.signf.bacteria <- paste0(maas.results.df.signf %>% pull(Feature) %>% unique %>% tolower, ".bacteria")

scatter.meta <- meta(pseq.genus) %>%
    tibble::rownames_to_column("id") %>%
      mutate(MAP = oMAP,
           PULSEPRESSURE = oPULSEPRESSURE,
           SYSTM = oSYSTM,
           DIASM = oDIASM)

scatter.abund <- abundances(pseq.genus, transform = "clr") %>%
    t %>%
    as.data.frame %>%
    tibble::rownames_to_column("id") %>%
    setNames(tolower(replace.brackets(names(.)))) %>%
    select(id, scatter.signf.bacteria) %>%
    mutate_at(.vars = vars(scatter.signf.bacteria), .funs = funs(myscale(.)))

scatter.full <- full_join(scatter.meta, scatter.abund, by = "id")

scatter.combinations <- expand.grid(cc("SYSTM", "DIASM", "PULSEPRESSURE", "MAP"),
                                    c2l(scatter.signf.bacteria)) %>%
    setNames(c("rr", "abund"))

scatter.plot <- function(df,
                         maas.results,
                         rr,
                         abund,
                         covariates = c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB",
                                        "BL_USE_RX_C03", "BL_USE_RX_C07", "BL_USE_RX_C08",
                                        "BL_USE_RX_C09"),
                         prediction = TRUE,
                         plots = TRUE) {
    fo <- sprintf("%s ~ %s + %s", rr, abund, paste0(covariates, collapse="+"))
    model <- lm(as.formula(fo), data = df)

    if (prediction == FALSE) return(model %>% summary)
    
    df.predict <- data.frame(BPV = seq(-5,5,0.1)) %>%
        mutate(SEX = as.factor(0),
               BL_AGE = df %>% pull(BL_AGE) %>% mean,
               BMI = df %>% pull(BMI) %>% mean,
               CURR_SMOKE = as.factor(0),
               Q57X = as.factor(1),
               DIAB = 0,
               BL_USE_RX_C03 = as.factor(0),
               BL_USE_RX_C07 = as.factor(0),
               BL_USE_RX_C08 = as.factor(0),
               BL_USE_RX_C09 = as.factor(0),
               !!abund := seq(-5,5,0.1)
               )
    prediction <- cbind(df.predict, predict(model, df.predict, interval = 'confidence'))

    if (plots == FALSE) return(prediction)

    feature <- firstup(gsub(".bacteria", "", replace.brackets(abund)))
    qval.maaslin <- maas.results %>%
        dplyr::filter(Feature == feature, Value == rr) %>%
        nrow
    
    if (qval.maaslin == 0) { return (ggplot() + ggplot2::theme_minimal()) }
    pval <- pub.p(summary(model)$coef[2,4])
    rsqr <- signif(summary(model)$adj.r.squared, 2)
    slope <- signif(model$coef[[2]], 2)

    ggplot(prediction, aes_string(x = abund, y = "fit")) +
        geom_line() +
        geom_point(size=0.1, shape=1, aes_string(x = abund, y = rr, color = "SEX"),
                   data = df) +
        labs(title = sprintf("Adj R2 = %s, Slope = %s, p = %s", rsqr, slope, pval)) +
        xlab(feature) +
        ylab(rr) +
        ylim(0,200) +
        ggplot2::theme_minimal() +
        theme(plot.title = element_text(size=8)) +
        theme(legend.position="none")
}

scatterplots <- lapply(data.frame(t(scatter.combinations)),
                       function(x)
                           scatter.plot(scatter.full, maas.results.df.signf, x$rr, x$abund))


scatterplot <- do.call("grid.arrange", c(scatterplots, ncol=4))
ggsave(file = "cache/scatter.png", plot = scatterplot, height = 20, width = 10, dpi = 300)
```



```{r Write figure 3}
fig3head <- "Associations between genus level abundances and blood pressure variables."
fig3foot <- "Only bacteria with significant associations are shown. Blood pressure variables are normalized and abundances are arcsin-square root transformed. Dark gray color represents insignificant associations."
writeimage(doc, 3, "cache/maaslin.png", fig3head, fig3foot)
```

### Lactobacillus

```{r lacto data frame}
lacto.abund <- subset_taxa(pseq.genus, Genus == "Lactobacillus") %>%
    abundances(., transform = "clr") %>%
    t %>%
    as.data.frame %>%
    tibble::rownames_to_column("id") %>%
    setNames(tolower(replace.brackets(names(.))))

lacto.full <- meta(pseq.genus) %>%
    tibble::rownames_to_column("id") %>%
    full_join(., lacto.abund, by = "id") %>%
    dplyr::mutate(fake_salt = relevel(factor(dplyr::ntile(BL_AGE, 4)), ref='1'),
                  lacto_groups = relevel(factor(dplyr::ntile(lactobacillus.bacteria, 4)), ref='1'))
```

```{r lacto adjusted means}
lacto.lm.salt <- lm(lactobacillus.bacteria ~ fake_salt + BL_AGE + SEX, data=lacto.full)

lacto.mean.unadjusted <- data.frame(
    fake_salt = as.factor(seq(4)),
    SEX = as.factor(0),
    BL_AGE = mean(lacto.full %>% pull(BL_AGE)))

lacto.mean.adjusted <- predict(lacto.lm.salt, lacto.mean.unadjusted, interval = "confidence") %>%
    as.data.frame %>%
    dplyr::rename(estimate = fit,
           conf.low = lwr,
           conf.high = upr) %>%
    tibble::rownames_to_column("term")
```

```{r lacto odds for hypertension}
lacto.odds <- glm(HYPERTENSION ~ lacto_groups + BL_AGE + SEX,
                  family = binomial(link=logit),
                  data=lacto.full) %>%
    broom::tidy(conf.int = TRUE, conf.level = 0.95, exponentiate = TRUE) %>%
    filter(!grepl("Intercept", term)) %>%
    select(term, estimate, conf.low, conf.high) %>%
    add_row(term = "lacto_groups1", estimate = 1.0, conf.low = NA, conf.high = NA) %>%
    dplyr::filter(grepl("lacto", term))
```

```{r lacto lm residuals}
ggplot2::autoplot(lm(lactobacillus.bacteria ~ fake_salt + BL_AGE + SEX, data=lacto.full))
``` 

```{r lacto logistic residuals}
ggplot2::autoplot(glm(HYPERTENSION ~ lacto_groups + BL_AGE + SEX, family = binomial(link=logit), data=lacto.full))
```

```{r lacto anova}
lacto.anova <- aov(lactobacillus.bacteria ~ fake_salt, data = lacto.full)
summary(lacto.anova)
TukeyHSD(lacto.anova)$fake_salt %>% kable
```

```{r lactoto test normality}
grid.arrange(ggqqplot(lacto.full$lactobacillus.bacteria, title = "Lactobacillus"),
             ggqqplot(lacto.full$BL_AGE, title = "BL_AGE"), ncol=2)
```

```{r forest plot lacto}
myforestplot <- function(data, xlab = "", ylab = "", ylimits = c(0,10), interceptone = FALSE, subtitle = "") {
    ggplot(data = data,
           aes(x = term, y = estimate, ymin = conf.low, ymax = conf.high)) +
        geom_point() +
        { if (interceptone) geom_hline(aes(fill=fake_salt), yintercept=1, linetype=2) } +
        geom_errorbar(width=0.1)+ 
        ggplot2::theme_minimal()  +
        theme(plot.title=element_text(size=16),
              axis.title=element_text(size=12),
              strip.background = element_blank()) +
        theme(panel.border = element_blank(),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.ticks.x = element_line(),
              axis.ticks.y = element_line(),
              axis.line = element_line(colour = "black")) +
        scale_x_discrete(labels=c("Q1", "Q2", "Q3", "Q4")) +
        scale_y_continuous(limits = ylimits, breaks = pretty(ylimits, 4)) + 
        xlab(xlab) +
        ylab(ylab) +
        labs(subtitle = subtitle)
}

gsalt <- grid.arrange(
    myforestplot(lacto.mean.adjusted,
                 xlab = "Dietary salt",
                 ylab = "Lactobacillus abundance",
                 subtitle = "A.",
                 ylimits = c(2.5,3)),
    myforestplot(lacto.odds,
                 xlab = "Lactobacillus abundance",
                 ylab = "Odds of hypertension",
                 subtitle = "B.",
                 ylimits = c(0.5, 1.5),
                 interceptone = TRUE),
    ncol=2)
ggsave(file = "cache/salt-forest.png", plot=gsalt, height=4, width=6, dpi = 300)
```

```{r Write figure 4}
fig4head <- "Associations between dietary salt, lactobacillus abundance, and odds for hypertension."
fig4foot <- "In panel A we see lactobacillus abundances in different dietary salt groups. The mean value is adjusted using age and sex. In panel B we split participants in four groups by lactobacillus abundances and calculate odds ratio for hypertension. Age and sex are included in logistic model. A 95 % CI is drawn in both panels."
writeimage(doc, 4, "cache/salt-forest.png", fig4head, fig4foot)
```

```{r Write docx to file}
print(doc, target = paste0("report/articletwo-", now, ".docx"))
```

```{r save session}
save.image(file = paste0("session/session-", now, ".Rdata"))
```
