---
title: "Hypertension and microbiome"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---
	
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, xecho = TRUE, message = FALSE, results='asis', cache=FALSE, warning=FALSE)
knitr::opts_chunk$set(cache.path = 'cache/', output.dir="cache/",
                      file.path = 'cache/', fig.path = 'cache/')

dir.create("rds/", showWarnings = FALSE)
dir.create("session/", showWarnings = FALSE)
```

# Command line arguments

Calculations ran at

```{r Command line arguments}
now <- format(Sys.time(), '%Y%m%d-%H%M%S')

if (exists("args")) {
    if ("time" %in% names(args)) now <- args$time
    
    if("clean" %in% names(args)) {
        unlink("rds", recursive=TRUE)
        unlink("cache", recursive=TRUE)
    }
    if ("tags" %in% names(args)) 
        rtags('~/phd/research/articletwo/', recursive = FALSE, pattern = '\\.[RrSs](rw|md)?$',ofile = '~/phd/research/articletwo/TAGS', verbose = TRUE, append = FALSE)
}
```

}
```
# Importing libraries:

```{r libraries, cache = FALSE}
library(dplyr)
library(tibble)
library(phyloseq)
library(microbiome)
library(finriskmetagcommon)
library(knitr)
library(tidyr)
library(vegan)
library(reshape)
library(ggpmisc)
library(Maaslin)
library(parallel)
library(officer)
library(flextable)
library(rvg)
library(tableone)
library(scales)
library(ggplot2)
library(gridExtra)
library(png)
library(pander)
```

Session info
 
```{r Session info}
pander(sessionInfo(), compact = TRUE)
```

```{r Initialize docx, include = FALSE, cache = FALSE}
doc <- read_docx(path = "style/articlestyle.docx") %>%
  body_remove()
dir.create("rds", showWarnings = FALSE)
dir.create("cache", showWarnings = FALSE)
```

# Sources

### Officer functions

```{r Officer importer, code=readLines("articletwo-officer.R")}
source("articletwo-officer.R")
```

### RR biome functions

```{r RR biome functions, code=readLines("articletwo-rrbiome.R")}
source("articletwo-rrbiome.R")
```

### EdgeR plot functions

```{r EdgeR functions, code=readLines("aaro/edgeR_plot_functions.R")}
source("aaro/edgeR_plot_functions.R")
```

### Plot functions

```{r Plot functions, code=readLines("articletwo-ggplot.R")}
source("articletwo-ggplot.R")
```

# Loading data
	
Loading descriptions for clinical data

```{r variables, warning = FALSE}
names.dset <- getdescriptions()
```

Loading phyloseq object

```{r data}
pseq.genus <- readRDS("data/phfinrisk_genus_all_drop50k_2018-11-16.RDs")
pseq.species <- readRDS("data/phfinrisk_species_all_drop50k_2018-12-21.RDs")
```

Updating phyloseq objects

```{r updating phyloseq objects}
phyloseq::sample_data(pseq.genus) <- phyloseq::sample_data(filter.phenotype.data(pseq.genus))
phyloseq::sample_data(pseq.species) <- phyloseq::sample_data(filter.phenotype.data(pseq.species))
```

```{r test scaling}
meta(pseq.genus) %>% summarize(mean(MAP), sd(MAP), mean(SYSTM), sd(SYSTM), mean(DIASM), sd(DIASM), mean(PULSEPRESSURE), sd(PULSEPRESSURE)) %>% kable
```

Sample data has dimensions (`r dim(sample_data(pseq.species))`).

## Models

```{r matrix calculation}
if (!file.exists("rds/bray.dist.m.species.rds")) {
    bray.dist.m.species <- calculate.beta.matrix(pseq.species)
    saveRDS(bray.dist.m.species, file = "rds/bray.dist.m.species.rds")
} else {
    bray.dist.m.species  <- readRDS("rds/bray.dist.m.species.rds")
}
```

 ```{r adonis calculation}
 if (!file.exists("rds/adonis.species.rds")) {
     adonis.species = list()
     adonis.species$min <- calculateadonis(dset = meta(pseq.species),
                                           matrix = bray.dist.m.species,
                                           covariates = c("BL_AGE", "SEX"),
                                           npermutations = 1000)
     adonis.species$max <- calculateadonis(dset = meta(pseq.species),
                                           matrix = bray.dist.m.species,
                                           covariates = c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB",
                                                          "BL_USE_RX_C03", "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09"),
                                           npermutations = 1000)
     saveRDS(adonis.species, file = "rds/adonis.species.rds")
    } else {
     adonis.species  <- readRDS("rds/adonis.species.rds")
}
```

```{r pca calculate}
if (!file.exists("rds/pca.prcomp.rds")) {
    pca.abundances  <- as.matrix(t(microbiome::abundances(microbiome::transform(pseq.species, "clr"))))
    pca.prcomp <- stats::prcomp(pca.abundances)
    saveRDS(pca.prcomp, file = "rds/pca.prcomp.rds")
} else {
    pca.prcomp <- readRDS("rds/pca.prcomp.rds")
}
```

```{r core taxa}
pseq.genus.core <- core(pseq.genus, detection = 0.001, prevalence = 0.01)
pseq.species.lactobacillus <- subset_taxa(pseq.species, Genus=="Lactobacillus")
pseq.species.lactobacillus.core <- core(pseq.species.lactobacillus, detection = 0.001, prevalence = 0.01)
```

At genus level core has number of taxa `r ntaxa(pseq.genus.core)` (`r
ntaxa(pseq.genus)`). For lactobacilli core has number of taxa `r
ntaxa(pseq.species.lactobacillus.core)` (`r ntaxa(pseq.species.lactobacillus)`).

```{r maaslin runs, results = 'hide'} 
maaslin <- list()

maaslin$genus <- maaslinwrapper(pseq = pseq.genus.core,
                looped = c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION"),
                forced = c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB", "BL_USE_RX_C03",
                           "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09"),
                taxa = "Halapricum.Archaea-")

lactotaxa <-c("Lactobacillus_delbrueckii.Bacteria", "Lactobacillus_ruminis.Bacteria", "Lactobacillus_acidophilus.Bacteria",
                    "Lactobacillus_fermentum.Bacteria", "Lactobacillus_paracasei.Bacteria", "Lactobacillus_salivarius.Bacteria")

maaslin$lacto.min <- maaslinwrapper(pseq = pseq.species.lactobacillus.core,
                looped = c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION"),
                forced = c("BL_AGE", "SEX"),
                taxa =  paste0(lactotaxa,  collapse = ","))

maaslin$lacto.max  <- maaslinwrapper(pseq = pseq.species.lactobacillus.core,
                looped = c("MAP", "SYSTM", "DIASM", "PULSEPRESSURE", "HYPERTENSION"),
                forced =c("BL_AGE", "SEX", "BMI", "CURR_SMOKE", "Q57X", "DIAB", "BL_USE_RX_C03",
                          "BL_USE_RX_C07", "BL_USE_RX_C08", "BL_USE_RX_C09"),
                taxa = paste0(lactotaxa, collapse = ","))

```


## Characteristics of the study sample. (Table 1.)

```{r Characteristics}
tbl1 <- tableone(meta(pseq.species))
```

```{r Write characteristics}
tbl1head <- "Characteristics of the study sample."
tbl1foot <- "Continuous variables are presented as mean (standard deviation). Categorical variables reported as absolute and relative frequencies. BP indicates blood pressure, BMI, body mass index, RAS, renin-angiotensin system."
writetable(doc, tbl1, number = 1, tbl1head, tbl1foot)
```

## Alpha & Beta plot (Figure 1.)

```{r alphabeta definitions}
dset.alpha <- meta.merge.alphadiversity(pseq.species)
alphadiversity <- list(
    min = calculateglm(dset.alpha, modelstring = "%s ~ BL_AGE + SEX  + diversities_shannon"),
    max = calculateglm(dset.alpha, modelstring = "%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09 + diversities_shannon"))
diversities <- mergediversities(alphadiversity, adonis.species)
```

Minimum coefficient for alpha diversity is `r rbind(diversities$min,
diversities$max) %>% pull(estimate) %>% min`.

```{r save grob}
alpha.diversity.min <- plot.alpha(diversities$min, colorlimit = 1.3)
alpha.diversity.max <- plot.alpha(diversities$max, colorlimit = 1.3)

beta.diversity.min <- plot.beta(diversities$min)
beta.diversity.max <- plot.beta(diversities$max)

gs4 <- list(alpha.diversity.min$yaxis,
            alpha.diversity.min$plot,
            beta.diversity.min$plot,
            alpha.diversity.min$legend,
            alpha.diversity.min$xaxis,
            beta.diversity.min$xaxis,
            beta.diversity.min$xlab,
            text_grob("A.", size = 18),
            alpha.diversity.max$yaxis,
            alpha.diversity.max$plot,
            beta.diversity.max$plot,  
            alpha.diversity.max$xaxis,
            beta.diversity.max$xaxis,
            beta.diversity.max$xlab,
            text_grob("B.", size = 18))
 
g4 <- arrangeGrob(grobs = gs4,
                   layout_matrix = rbind(
                      c(8,    NA,    NA, NA,   NA, NA, NA),
                      c(NA, 1,    2,    NA, 3, NA, NA),
                      c(NA, 1,    2,    NA, 3, NA, 4),
                      c(NA, NA, 5,    NA,6, NA, NA),
                      c(NA, NA, NA, NA,7, NA, NA),
                      c(15,    NA,    NA, NA,   NA, NA, NA),
                      c(NA, 9,    10,  NA,  11, NA, NA),
                      c(NA, 9,    10,  NA,  11, NA, NA),
                      c(NA, NA, 12,   NA, 13, NA, NA),
                      c(NA, NA, NA, NA,14, NA, NA)),
                  widths=c(0.7, 4, 0.7, 0.1, 5, 0.7, 3),
                  heights=rep(c(1, 1, 6, 1, 2), 2))

ggsave(file = "cache/alpha-beta.png", plot=g4, height=6, width=9)
```

```{r Write figure 1}
fig1head <- "Associations between BP variables and microbial diversity"
fig1foot <- "Results in panel A are calculated using minimal model using only age and sex for covariates. Panel B has the full model where covariates are age, sex, BMI, smoker, exercise, and four antihypertensive medications. The blue tinted box on the left represents four linear and one logistic model where blood pressure variables are dependant variables and Shannon's index is included in covariates. The gray tinted bars represent beta diversity i.e. analysis of variance for Bray-Curtis distance matrix where blood pressure variables are included in covariates. Result marked with asterisk are significant at FDR 0.05. Permutational analysis for beta diverity has 1000 permutations (p=0.01)."
writeimage(doc, 1, "cache/alpha-beta.png", fig1head, fig1foot)
```

## Principal component analysis (Figure 2.)

```{r pca plot}
pca.eigs <- pca.prcomp$sdev^2
pca.percentage <- 100 * pca.eigs /sum(pca.eigs)
pca.labels <- sprintf("%s (%.2f %%)", colnames(pca.prcomp$x), pca.percentage)

pcaplot <- ggplot(cbind(meta(pseq.species), pca.prcomp$x[,1:2]), aes(x=PC1, y=PC2)) +
    geom_point(aes(color = HYPERTENSION), size = 0.5) +
    scale_color_manual(values=c("blue", "red"),
                       name= "Hypertension",
                       breaks=c("1", "0"),
                       labels=c("Yes", "No")) +
    xlab(pca.labels[1]) +
    ylab(pca.labels[2]) +
    coord_fixed() +
    scale_x_continuous(breaks=seq(-100, 100, 20)) +
    scale_y_continuous(breaks=seq(-30, 30, 10)) +
    theme_classic() +
    theme(text = element_text(size=20),
          legend.justification=c(1,0),
          legend.position=c(1.03, 0.75),
          legend.title=element_text(size = 20),
          legend.direction="vertical",
          legend.text=element_text(size = floor(0.75*20)),
          legend.box.margin = margin(1, 1, 1, 1, "mm"),
          legend.box.background = element_rect(colour = "black"))

ggsave(file = "cache/pca.png", plot = pcaplot, height = 5, width = 9, dpi = 300)
```

```{r Write figure 2}
fig2head <- "Tenth of bacterial variation can be explained by two first principal axes"
fig2foot <- sprintf("Principal component analysis for bacterial abundances at species level. Centered log ratio transform is performed for the compositional data. First two axes explain %.1f%% of the variation. Research participants with hypertension are denoted by red dot.", sum(pca.percentage[1:2]))
writeimage(doc, 2, "cache/pca.png", fig2head, fig2foot)
```

## Direct associations between genus level and blood pressure variables (figure 3)

```{r maaslin}
maas.results.df.signf <- maaslin$genus %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
           beta = Coefficient) %>%
   dplyr::filter(Qval < 0.05) 

maaslinplot <- plot_maaslin_heatmap_final(maas.results.df.signf %>% dplyr::filter(Variable != "HYPERTENSION"),
                      beta.maxabs=max(abs(maas.results.df.signf[,'beta'])),
                      order.by.category=FALSE)

ggsave(file = "cache/maaslin.png", plot = maaslinplot, height = 3, width = 7, dpi = 300)
```

```{r Write figure 3}
fig3head <- ""
fig3foot <- ""
writeimage(doc, 3, "cache/maaslin.png", fig3head, fig3foot)
```


## Figure 4

```{r PC plot}
pca.prcomp.df <- pca.prcomp$x[,1:5] %>% data.frame
#pca.prcomp$sdev[1:20]^2/sum(pca.prcomp$sdev^2)
#cumsum(pca.prcomp$sdev[1:20]^2/sum(pca.prcomp$sdev^2))

X <- base::merge(meta(pseq.species), pca.prcomp.df, by=0, all=TRUE) %>%
    dplyr::rename(Sample_ID = Row.names) 

X.res <- lapply(vectortolist(paste0("PC", seq(5))), function(axis) {
    modelstring <- paste0("%s ~  BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09 + ", axis)
    calculateglm(X, modelstring = modelstring, filterstr = "PC")
})

Z.df <-  do.call(rbind.data.frame, X.res) %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="response", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(p.value, method="BH"),
                  beta = estimate,
                  Feature = term)

p2 <- plot_maaslin_heatmap_final(Z.df , fname="Feature", pname="Name",
                                  xlab.text = "PC", signif="Qval", cluster=FALSE,
                                  v.title.name = "Effect size (PC)",
                                  ystr="reorder(Name, Qval)", sign.name="Significance.PC",
                                  no.sign.legend=TRUE)

ggsave(file = "cache/pca.p2.png", plot = p2, height = 8, width = 8, dpi = 300) 
```


```{r Write figure 4}
fig4head <- "P2"
fig4foot <- ""
writeimage(doc, 4, "cache/pca.p2.png", fig4head, fig4foot)
```


## Figure 5

```{r PCA heatmap}
pca.axis <- pca.prcomp$x %>% data.frame
pca.dset <- base::merge(meta(pseq.species), pca.axis[,1:5], by=0, all=TRUE) %>%
  dplyr::rename(Sample_ID = Row.names)

pca.dset %>% head

pca.ret <- lapply(paste0("PC", seq(1,5)), function (pc) {
    calculateglm(pca.dset,
                 modelstring = paste("%s ~ BL_AGE + SEX + BMI + CURR_SMOKE + Q57X + DIAB + BL_USE_RX_C03 + BL_USE_RX_C07 + BL_USE_RX_C08 + BL_USE_RX_C09  +", pc),
                 filterstr = "PC") %>%
        select(response, estimate, p.value) %>%
        mutate(model_name = pc)
})

pca.ret  %>%
    data.table::rbindlist() %>%
    as.data.frame %>%
    mutate(p.value = p.adjust(p.value, method="BH")) %>%
    arrange(p.value) %>%
    kable
```

## Loadings for principal component axis 3 (Figure 5)

```{r Main contributors of PC3}
pca.rotation.abs <- abs(pca.prcomp$rotation)
pca.loading <- sweep(pca.rotation.abs, 2, colSums(pca.rotation.abs), "/") %>%
	    as.data.frame %>%
    tibble::rownames_to_column(var = "term") %>%
    mutate(name = rename.genus(term))
	


pca.loading.pc3.top20 <- pca.loading %>%
    select(name, PC3) %>%
    arrange(-PC3) %>%
    head(20)

pca.pc3.gg <- ggplot(data=pca.loading.pc3.top20, aes(x=reorder(name, -PC3), y=100*PC3)) +
    geom_bar(stat="identity", width=0.5, position = position_dodge(preserve = "single")) +
    theme_classic(20) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1)) +
    xlab("") +
    ylab("Contribution (%)") +
    scale_y_continuous(limits=c(0, 2.7), oob = rescale_none, expand = c(0,0)) +
    theme(axis.title.x=element_blank(),
          text = element_text(size=20),
          legend.justification=c(1,0),
          legend.position=c(1.03, 0.75),
          legend.title=element_text(size = 20),
          legend.direction="vertical",
          legend.text=element_text(size = floor(0.75*20)),
          legend.box.margin = margin(1, 1, 1, 1, "mm"),
          legend.box.background = element_rect(colour = "black"),
          aspect.ratio = 0.7)
   ggsave(file = "cache/pca.pc3.png", plot = pca.pc3.gg, height = 8, width = 8, dpi = 300) 
```

```{r Write figure 5}
fig5head <- "Bacteria causing dysentery and diarrhea contribute to third principal component"
fig5foot <- sprintf("Top 20 bacterial contributors to third principal coordinate at species level. Centered log ratio transform is performed for the compositional data. Third principal component explain %.1f%% of the total variation. Plasmid DNA is denoted using star.", pca.percentage[3])
writeimage(doc, 5, "cache/pca.pc3.png", fig5head, fig5foot)
```

### Lactobacillus

Lacto min

```{r Reading maaslin lacto min output}
maaslin$lacto.min %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
                  beta = Coefficient) %>% 
    select(Variable, Feature, Coefficient, P.value, Q.value) %>%
    arrange(Q.value) %>%
    mutate_if(is.numeric, funs(ifelse(. < 0.01, sprintf("%.1e", .), round(., 2)))) %>%
    kable
```

Lacto max

```{r Reading maaslin lacto max output}
maaslin$lacto.max %>%
    merge(names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
                  beta = Coefficient) %>%
    select(Variable, Feature, Coefficient, P.value, Q.value) %>%
    arrange(Q.value) %>%
    mutate_if(is.numeric, funs(ifelse(. < 0.01, sprintf("%.1e", .), round(., 2)))) %>%
    kable
```

```{r lactobacillus table}
allruns.unamb <- turkumetabolites::unambiguous.lmrank(dset$fr02, linear.lmrank)
allruns.sup <- turkumetabolites::pub.lmrank(allruns.unamb,  p = 0.05/330)

maaslin.lacto.max.table <- maaslin$lacto.max %>%
    dplyr::mutate(Qval = p.adjust(P.value, method="BH"),
                  beta_ci =sprintf("%.1E", Coefficient, NA),
                  p.value = sprintf("%.2f", p.adjust(P.value, method="BH"))) %>%
    merge(., names.dset %>% select(Covariate, Category, Name), by.x ="Variable", by.y = "Covariate") %>%
    select(Feature, Name, beta_ci, p.value) %>%
    gather(variable, value, -Feature, -Name) %>%
    unite(temp, Name, variable) %>%
    spread(temp, value) %>%
    mutate(Feature = rename.genus(gsub("_Bacteria", "", Feature))) %>%
    arrange(Feature)

names(maaslin.lacto.max.table) <- gsub(" ", "_", names(maaslin.lacto.max.table ))

typology.tbl2 <- data.frame(col_keys = c("Feature",
                                         "Mean_arterial_pressure_beta_ci",
                                         "Mean_arterial_pressure_p.value",
                                         "Systolic_BP_beta_ci",
                                         "Systolic_BP_p.value",
                                         "Diastolic_BP_beta_ci",
                                         "Diastolic_BP_p.value",
                                         "Pulse_pressure_beta_ci",
                                         "Pulse_pressure_p.value",
                                         "Hypertension_beta_ci",
                                         "Hypertension_p.value"),
                            what = c( "",
                                     rep("MAP", 2), 
                                     rep("Systolic BP", 2), 
                                     rep("Diastolic BP", 2), 
                                     rep("Pulse pressure", 2), 
                                     rep("Hypertension", 2)),
                            measure = c("Lactobacillus", rep(c("β±SE", "p"), 5)),
                            stringsAsFactors = FALSE)

tbl2 <- flextable(data = maaslin.lacto.max.table) %>%
    set_header_df(mapping = typology.tbl2, key = "col_keys") %>%
        flextable::theme_booktabs()
writetable(doc, tbl2, number = 2, tbl2head, tbl2foot)
print(doc, target = paste0("report/articletwo-test.docx"))
```

```{r write table 2}
tbl2head <- "Lactobacilli"
tbl2foot <- ""
writetable(doc, tbl2, number = 2, tbl2head, tbl2foot)
```


```{r Write docx to file}
print(doc, target = paste0("report/articletwo-", now, ".docx"))
```

```{r save session}
save.image(file = paste0("session/session-", now, ".Rdata"))
```
